<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ruta Óptima de Producción - Deck Heroes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e0e1e6;
      color: #222;
      margin: 0;
      padding: 0;
    }
    .container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      width: 95vw;
      max-width: 900px;
      margin: 32px auto 0 auto;
      padding: 32px 18px 32px 18px;
    }
    h1 {
      text-align: center;
      color: #1e3a8a;
      margin-bottom: 8px;
    }
    .desc {
      text-align: center;
      color: #555;
      margin-bottom: 28px;
      font-size: 1.08em;
    }
    .panel {
      background: #f5f6fa;
      border-radius: 8px;
      padding: 18px 14px;
      margin-bottom: 18px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .panel-title {
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 8px;
      font-size: 1.1em;
    }
    .ruta-optima, .cronograma {
      min-height: 60px;
      color: #333;
      font-size: 1.08em;
    }
    .controles {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 18px;
    }
    .controles > * {
      font-size: 1em;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: #f5f6fa;
      color: #222;
      transition: background 0.2s;
      cursor: pointer;
    }
    .controles > *:hover {
      background: #e0e1e6;
    }
    @media (max-width: 600px) {
      .container { padding: 12px 2vw; }
      .panel { padding: 10px 4px; }
    }
    .simulacion-grid {
      display: grid;
      grid-template-columns: 3fr 2fr;
      gap: 24px;
      width: 90vw;
      max-width: 1200px;
      margin: 0 auto 32px auto;
      align-items: flex-start;
    }
    .simulacion-col {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 18px 14px 18px 14px;
      min-height: 320px;
    }
    .tabla-pasos {
      width: 100%;
      border-collapse: collapse;
      font-size: 1em;
      margin-bottom: 12px;
    }
    .tabla-pasos th, .tabla-pasos td {
      border: 1px solid #bbb;
      padding: 6px 8px;
      text-align: center;
    }
    .tabla-pasos th {
      background: #e0e1e6;
      color: #222;
    }
    .tabla-pasos tr:nth-child(even) {
      background: #f5f6fa;
    }
    .sugerencias-auto {
      margin-top: 10px;
      color: #1976d2;
      font-size: 1.01em;
    }
    .inventario-final-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.98em;
    }
    .inventario-final-table th, .inventario-final-table td {
      border: 1px solid #bbb;
      padding: 5px 7px;
      text-align: center;
    }
    .inventario-final-table th {
      background: #e0e1e6;
      color: #222;
    }
    .inventario-final-table tr:nth-child(even) {
      background: #f5f6fa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ruta Óptima de Producción</h1>
    <div class="desc">
      Aquí podrás ver la mejor secuencia de pasos para fabricar tu equipo, optimizando materiales y tiempo.<br>
      Próximamente: simulador interactivo, cronograma y sugerencias inteligentes.
    </div>
    <div class="controles">
      <!-- Aquí irán los controles para seleccionar objetivo, cargar inventario, etc. -->
      <button disabled>Seleccionar objetivo</button>
      <button disabled>Cargar inventario</button>
      <button disabled>Simular ruta óptima</button>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
      <button id="btn-cargar-datos" style="background:#888;color:#fff;padding:7px 18px;border:none;border-radius:6px;cursor:pointer;font-size:1em;">Cargar datos</button>
      <input type="file" id="file-recetas" accept=".json,application/json" style="display:none;">
      <input type="file" id="file-materiales" accept=".json,application/json" style="display:none;">
    </div>
    <div style="margin:18px 0 8px 0;">
      <label style="font-weight:normal;cursor:pointer;"><input type="checkbox" id="chk-desmantelar" style="margin-right:6px;">Considerar desmantelado de equipos dorados de nivel 1</label>
    </div>
    <div id="panel-bases" style="background:#f5f6fa;padding:10px 8px 8px 8px;margin-bottom:18px;border-radius:8px;">
      <b>Bases disponibles:</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
        <select id="base-equipo"></select>
        <select id="base-clase"></select>
        <select id="base-nivel"></select>
        <select id="base-color"></select>
        <button id="btn-agregar-base" type="button">Agregar base</button>
      </div>
      <table id="tabla-bases" style="width:auto;font-size:0.98em;"><thead><tr><th>Equipo</th><th>Clase</th><th>Nivel</th><th>Color</th><th></th></tr></thead><tbody></tbody></table>
    </div>
    <div id="simulacion-columna-unica">
      <div style="font-weight:bold;font-size:1.12em;margin-bottom:8px;">Pasos de simulación</div>
      <table class="tabla-pasos">
        <thead>
          <tr>
            <th>Paso</th>
            <th>Acción</th>
            <th>Color</th>
            <th>Cantidad</th>
            <th>Faltante</th>
            <th>Resultado</th>
            <th>Éxito</th>
          </tr>
        </thead>
        <tbody class="tbody-pasos">
          <!-- Aquí se llenarán los pasos de la simulación -->
        </tbody>
      </table>
      <div class="sugerencias-auto"></div>
      <div class="ruta-optima"></div>
      <div class="cronograma"></div>
      <div class="advertencias"></div>
      <div style="font-weight:bold;font-size:1.12em;margin:18px 0 8px 0;">Inventario final tras la simulación</div>
      <table class="inventario-final-table">
        <thead>
          <tr>
            <th>Material</th>
            <th>Dorado</th>
            <th>Morado</th>
            <th>Azul</th>
            <th>Verde</th>
            <th>Blanco</th>
          </tr>
        </thead>
        <tbody class="tbody-inventario-final">
          <!-- Aquí se llenará el inventario final -->
        </tbody>
      </table>
    </div>
  </div>
  <!-- Toast notification -->
  <div id="toast" style="display:none;"></div>
  <script type="module">
  import { cargarRecetasPersonalizadas, inicializarAlmacenamientoMateriales } from '../scripts/materiales.js';
  import { datosMateriales, mapaColores, nivelesPorClase, coloresPorClase } from '../scripts/datos.js';

  // Estado global simple
  const estado = {
    materialesData: datosMateriales,
    almacenMateriales: {},
    recetas: [],
    recetaFinalIndex: '',
    filtros: {
      clase: '',
      equipo: '',
      color: '',
      nivel: ''
    },
    seleccionBaseAlternativa: '', // equipo base alternativo elegido
    seleccionColorBase: '', // color de base elegido en bifurcación
    basesUsuario: [], // array de bases agregadas por el usuario
  };

  // Cargar recetas y materiales automáticamente si existen
  function cargarDatosUsuario() {
    let recetasCargadas = false;
    try {
      const r = cargarRecetasPersonalizadas();
      if (r && Object.keys(r).length > 0) {
        estado.recetas = r;
        recetasCargadas = true;
      }
    } catch {}
    if (!recetasCargadas) {
      inicializarAlmacenamientoMateriales(estado);
      estado.recetas = cargarRecetasPersonalizadas();
    }
  }
  cargarDatosUsuario();

  function getRecetasFiltradas() {
    return Object.keys(estado.recetas).filter(k => {
      const r = estado.recetas[k];
      if (estado.filtros.clase && r.clase !== estado.filtros.clase) return false;
      if (estado.filtros.equipo && r.equipo !== estado.filtros.equipo) return false;
      if (estado.filtros.color && r.color !== estado.filtros.color) return false;
      if (estado.filtros.nivel && r.nivel !== estado.filtros.nivel) return false;
      return ['Campeón','Planewalker','Lord','Noble Lord'].includes(r.clase);
    });
  }

  function formatearNombreReceta(r) {
    if (!r || typeof r !== 'object') return '';
    const clase = r.clase || '';
    const color = r.color ? (r.color.charAt(0).toUpperCase() + r.color.slice(1)) : '';
    const equipo = r.equipo || '';
    const nivel = r.nivel || '';
    let base = '-';
    if (r.base && typeof r.base === 'object') {
      base = (r.base.clase || '') + ' ' + (r.base.nivel || '') + ' ' + (r.base.color || '');
    }
    return `${clase} ${color} (${equipo}, Nivel ${nivel}, Base: ${base})`;
  }

  function renderControles() {
    const controles = document.querySelector('.controles');
    controles.innerHTML = '';
    // Solo mostrar controles si hay recetas y materiales cargados
    if (!Array.isArray(estado.recetas) || estado.recetas.length === 0 || !estado.almacenMateriales || Object.keys(estado.almacenMateriales).length === 0) {
      // No mostrar nada
      return;
    }
    // Escoger equipo (solo los 6 válidos)
    const equiposValidos = ['espada','pecho','botas','casco','guantes','cinturón'];
    const selectEquipo = document.createElement('select');
    selectEquipo.style.minWidth = '120px';
    selectEquipo.innerHTML = '<option value="">Escoger equipo...</option>';
    equiposValidos.forEach(eq => {
      const opt = document.createElement('option');
      opt.value = eq;
      opt.textContent = eq.charAt(0).toUpperCase() + eq.slice(1);
      if (eq === estado.filtros.equipo) opt.selected = true;
      selectEquipo.appendChild(opt);
    });
    selectEquipo.onchange = e => { estado.filtros.equipo = e.target.value; renderControles(); };
    controles.appendChild(selectEquipo);
    // Selector de receta final (mostrar tal cual se han cargado)
    const selectReceta = document.createElement('select');
    selectReceta.style.minWidth = '220px';
    selectReceta.innerHTML = '<option value="">Selecciona receta final...</option>';
    estado.recetas.forEach((r, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = formatearNombreReceta(r);
      if (idx == estado.recetaFinalIndex) opt.selected = true;
      selectReceta.appendChild(opt);
    });
    selectReceta.onchange = e => { estado.recetaFinalIndex = e.target.value; renderSimulacion(); };
    controles.appendChild(selectReceta);
    // Botón simular ruta óptima
    const btnSimular = document.createElement('button');
    btnSimular.textContent = 'Simular ruta óptima';
    btnSimular.style.marginLeft = '16px';
    btnSimular.style.padding = '7px 18px';
    btnSimular.style.fontSize = '1em';
    btnSimular.style.background = '#1976d2';
    btnSimular.style.color = '#fff';
    btnSimular.style.border = 'none';
    btnSimular.style.borderRadius = '6px';
    btnSimular.style.cursor = 'pointer';
    btnSimular.onclick = () => simularRutaOptima();
    controles.appendChild(btnSimular);
  }

  function renderInventarioFinal() {
    // Mostrar el inventario actual cargado, no el de la simulación
    let html = '';
    Object.keys(estado.almacenMateriales).forEach(key => {
      const mat = key.split(':')[1];
      html += `<tr><td>${mat}</td>`;
      ['dorado','morado','azul','verde','blanco'].forEach(c => {
        html += `<td>${estado.almacenMateriales[key][c] ? estado.almacenMateriales[key][c] : 0}</td>`;
      });
      html += '</tr>';
    });
    return html;
  }

  function calcularRutaYTiempo(recetaKey) {
    if (!recetaKey || !estado.recetas[recetaKey]) return { pasos: [], tiempoTotal: 0, advertencias: ['Selecciona una receta final válida.'] };
    const recetaFinal = estado.recetas[recetaKey];
    let pasos = [];
    let advertencias = [];
    let tiempoTotal = 0;
    let secuencia = [];
    // 1. Recetas normales de nivel 1 (blanco, luego morado, luego dorado)
    for (const color of ['blanco','morado','dorado']) {
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '1' && r.color === color && r.equipo === recetaFinal.equipo;
      });
      if (k) secuencia.push(k);
      else advertencias.push(`Falta receta: Normal 1 ${color}`);
    }
    // 2. Niveles 2, 3, 4 (dorado)
    for (let n = 2; n <= 4; n++) {
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === String(n) && r.color === 'dorado' && r.equipo === recetaFinal.equipo;
      });
      if (k) secuencia.push(k);
      else advertencias.push(`Falta receta: Normal ${n} dorado`);
    }
    // 3. Lógica de base según clase avanzada
    let baseMsg = '';
    if (recetaFinal.clase === 'Planewalker') {
      // Base: equipo Normal de nivel 5 y del mismo tipo
      baseMsg = `Base requerida: ${recetaFinal.equipo} Normal nivel 5 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '5' && r.equipo === recetaFinal.equipo;
      });
      if (k) secuencia.push(k);
      else advertencias.push(`Falta receta base: Normal 5 (${recetaFinal.equipo})`);
    } else if (recetaFinal.clase === 'Lord') {
      // Base: equipo Normal de nivel 5, cualquier tipo
      baseMsg = `Base requerida: cualquier equipo Normal nivel 5 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '5';
      });
      if (!k) advertencias.push(`Falta receta base: Normal 5 (cualquier equipo)`);
    } else if (recetaFinal.clase === 'Noble Lord') {
      // Base: equipo Lord de nivel 5, cualquier tipo
      baseMsg = `Base requerida: cualquier equipo Lord nivel 5 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Lord' && r.nivel === '5';
      });
      if (!k) advertencias.push(`Falta receta base: Lord 5 (cualquier equipo)`);
    } else if (recetaFinal.clase === 'Campeón') {
      // Base: equipo Normal de nivel 4 y mismo tipo
      baseMsg = `Base requerida: ${recetaFinal.equipo} Normal nivel 4 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '4' && r.equipo === recetaFinal.equipo;
      });
      if (!k) advertencias.push(`Falta receta base: Normal 4 (${recetaFinal.equipo})`);
    }
    // 4. Receta final
    secuencia.push(recetaKey);
    // Procesar cada paso
    for (const k of secuencia) {
      const r = estado.recetas[k];
      if (!r) continue;
      const tiempos = { dorado: 512, morado: 128, azul: 32, verde: 8, blanco: 2 };
      let tiempo = 0;
      Object.entries(r.materiales).forEach(([col, cant]) => {
        tiempo += (tiempos[col] || 0) * (cant || 0);
      });
      tiempoTotal += tiempo;
      pasos.push({
        nombre: formatearNombreReceta(r),
        materiales: r.materiales,
        tiempo,
        tasaExito: r.tasaExito || r.porcentaje || 100
      });
    }
    return { pasos, tiempoTotal, advertencias, baseMsg };
  }

  function formatearTiempo(horas) {
    if (!horas || isNaN(horas)) return '0h';
    const meses = Math.floor(horas / (30*24));
    let resto = horas % (30*24);
    const semanas = Math.floor(resto / (7*24));
    resto = resto % (7*24);
    const dias = Math.floor(resto / 24);
    const h = resto % 24;
    let partes = [];
    if (meses) partes.push(`${meses} mes${meses>1?'es':''}`);
    if (semanas) partes.push(`${semanas} semana${semanas>1?'s':''}`);
    if (dias) partes.push(`${dias} día${dias>1?'s':''}`);
    if (h) partes.push(`${h} h`);
    return partes.join(', ') || '0h';
  }

  function renderDesmantelado() {
    // Solo implementado para equipo dorado de nivel 1
    // Tiempo fabricar equipo dorado de nivel 1: 388h
    // Tiempo fabricar 1 material dorado desde cero: 512h
    // Ahorro: 124h
    let html = `<b>Desmantelado de equipo dorado de nivel 1</b><br>`;
    html += `Si fabricas un equipo dorado de nivel 1 (<b>388h</b>) y lo desmantelas, obtienes 1 material dorado al azar (de los 2 usados en la receta).<br>`;
    html += `Si el material obtenido es el que necesitas, <b>te ahorras 124 horas</b> respecto a fabricarlo desde cero (<b>512h</b>).`;
    html += `<br><span style='color:#888;font-size:0.98em;'>(Esta mecánica puede cambiar para otros niveles. Por ahora, solo está confirmada para nivel 1. Para nivel 5, se cree que da 2 materiales, pero no está confirmado.)</span>`;
    document.querySelector('.desmantelado').innerHTML = html;
  }

  function simularPasos(recetaFinal, inventarioOriginal) {
    if (!recetaFinal) return { pasos: [], inventarioFinal: {}, sugerencias: ['Selecciona una receta final válida.'], cronograma: [] };
    // Copia profunda del inventario
    let inventario = JSON.parse(JSON.stringify(inventarioOriginal));
    let pasos = [];
    let sugerencias = [];
    let pasoNum = 1;
    let cronograma = [];
    let tiempoTotal = 0;
    // Helper para descontar materiales del inventario
    function descontarMateriales(materiales) {
      let faltantes = {};
      for (const color in materiales) {
        let req = materiales[color];
        if (!req) continue;
        let disp = inventario[color] || 0;
        if (disp >= req) {
          inventario[color] -= req;
          req = 0;
        } else {
          inventario[color] = 0;
          req -= disp;
        }
        if (req > 0) faltantes[color] = req;
      }
      return faltantes;
    }
    // 1. Procesar materiales de la receta final
    Object.entries(recetaFinal.materiales).forEach(([color, cantidad]) => {
      if (cantidad > 0) {
        let usado = Math.min(inventario[color] || 0, cantidad);
        if (usado > 0) {
          pasos.push({
            paso: pasoNum++,
            accion: `Usar ${usado} ${recetaFinal.equipo} en ${color}`,
            color,
            cantidad: usado,
            faltante: 0
          });
          inventario[color] -= usado;
        }
        let faltan = cantidad - usado;
        if (faltan > 0) {
          pasos.push({
            paso: pasoNum++,
            accion: `Falta ${faltan} ${recetaFinal.equipo} en ${color}`,
            color,
            cantidad: 0,
            faltante: faltan
          });
        }
      }
    });
    // 2. Sugerencias automáticas
    if (pasos.length && pasos[0].materiales && pasos[0].materiales.includes('0')) {
      sugerencias.push('Puedes saltar los primeros pasos usando materiales de tu inventario.');
    }
    // Si falta algún material al final
    for (const color of ['dorado','morado','azul','verde','blanco']) {
      if ((inventario[color]||0) < 0) {
        sugerencias.push(`Te falta ${-inventario[color]} ${color}${-inventario[color]>1?'s':''} para completar la simulación.`);
      }
    }
    // Para cada paso, estimar tiempo (ejemplo: dorado=512h, morado=128h, azul=32h, verde=8h, blanco=2h)
    pasos.forEach(p => {
      let tiempo = 0;
      if (p.color) {
        if (p.color === 'dorado') tiempo = 512 * (p.cantidad || p.faltante || 1);
        else if (p.color === 'morado') tiempo = 128 * (p.cantidad || p.faltante || 1);
        else if (p.color === 'azul') tiempo = 32 * (p.cantidad || p.faltante || 1);
        else if (p.color === 'verde') tiempo = 8 * (p.cantidad || p.faltante || 1);
        else if (p.color === 'blanco') tiempo = 2 * (p.cantidad || p.faltante || 1);
      }
      tiempoTotal += tiempo;
      cronograma.push({ paso: p.paso, accion: p.accion, color: p.color, tiempo });
    });
    // Ejemplo para equipo base alternativo:
    let equiposDisponibles = ['espada','botas','casco','cinturón']; // <- esto debe calcularse según inventario
    if (equiposDisponibles.length > 1) {
      pasos.push({
        paso: pasoNum++,
        accion: 'Selecciona equipo base alternativo:',
        selectEquipo: true,
        opciones: equiposDisponibles,
        seleccionado: estado.seleccionBaseAlternativa || equiposDisponibles[0]
      });
    }
    // Ejemplo para bifurcación de color:
    let coloresBase = ['morado','dorado'];
    pasos.push({
      paso: pasoNum++,
      accion: '¿Qué color obtuviste en la base?',
      selectColor: true,
      opciones: coloresBase,
      seleccionado: estado.seleccionColorBase || coloresBase[0]
    });
    return { pasos, inventarioFinal: inventario, sugerencias, cronograma, tiempoTotal };
  }

  function simularRutaOptima() {
    // 1. Obtener selección
    const idxReceta = parseInt(estado.recetaFinalIndex);
    if (isNaN(idxReceta) || !estado.recetas[idxReceta]) {
      showToast('Selecciona una receta final válida.','error');
      return;
    }
    const recetaFinal = estado.recetas[idxReceta];
    const equipo = recetaFinal.equipo;
    const clase = recetaFinal.clase;
    const nivel = recetaFinal.nivel;
    // 2. Copia profunda del inventario
    let inventario = JSON.parse(JSON.stringify(estado.almacenMateriales));
    // 3. Buscar la cadena de recetas necesarias para llegar al objetivo
    //    (de nivel 1 a nivel final, con bifurcaciones)
    let pasos = [];
    let advertencias = [];
    let tiempoTotal = 0;
    let rutas = [];

    // Helper: obtener receta por clase, equipo, nivel, color
    function buscarReceta(clase, equipo, nivel, color) {
      return estado.recetas.find(r => r.clase === clase && r.equipo === equipo && r.nivel == nivel && r.color === color);
    }

    // Helper: simular fabricación de un equipo de nivel y color dados
    function fabricarEquipo(clase, equipo, nivel, color, inventarioActual, rutaParcial, tiempoAcumulado) {
      const receta = buscarReceta(clase, equipo, nivel, color);
      if (!receta) {
        advertencias.push(`Falta receta: ${clase} ${equipo} nivel ${nivel} color ${color}`);
        return { ruta: rutaParcial, inventario: inventarioActual, tiempo: tiempoAcumulado };
      }
      // 1. Para cada material requerido, intentar usar del inventario (con conversiones)
      let inventarioNuevo = JSON.parse(JSON.stringify(inventarioActual));
      let paso = { paso: rutaParcial.length+1, accion: `Fabricar ${clase} ${equipo} nivel ${nivel} color ${color}`, materiales: [], tiempo: 0, bifurcacion: false };
      let tiempoPaso = 0;
      let exito = true;
      for (const [matColor, cantidad] of Object.entries(receta.materiales)) {
        if (!cantidad || cantidad <= 0) continue;
        // Buscar el material correcto para este equipo
        const key = `${clase}:${receta["material1"] || receta["material"] || Object.keys(receta.materiales)[0]}`;
        // Usar el material del color requerido, o convertir
        let disponible = inventarioNuevo[key]?.[matColor] ? parseInt(inventarioNuevo[key][matColor]) : 0;
        let usado = Math.min(disponible, cantidad);
        inventarioNuevo[key][matColor] = disponible - usado;
        let faltan = cantidad - usado;
        // Si faltan, intentar convertir colores inferiores
        let ordenColores = ["blanco","verde","azul","morado","dorado"];
        let idxColor = ordenColores.indexOf(matColor);
        let conversiones = [];
        let convertido = 0;
        let colorActual = matColor;
        while (faltan > 0 && idxColor > 0) {
          let colorInferior = ordenColores[idxColor-1];
          let reqInferior = faltan * 4;
          let dispInferior = inventarioNuevo[key]?.[colorInferior] ? parseInt(inventarioNuevo[key][colorInferior]) : 0;
          let puedeConvertir = Math.floor(dispInferior / 4);
          let convierte = Math.min(puedeConvertir, faltan);
          if (convierte > 0) {
            inventarioNuevo[key][colorInferior] -= convierte*4;
            inventarioNuevo[key][matColor] = (inventarioNuevo[key][matColor]||0) + convierte;
            conversiones.push(`Convertidos ${convierte*4} ${colorInferior} → ${convierte} ${matColor}`);
            faltan -= convierte;
            convertido += convierte;
          }
          idxColor--;
        }
        if (faltan > 0) {
          exito = false;
          paso.materiales.push(`${key.split(':')[1]}: Faltan ${faltan} de color ${matColor}`);
        } else {
          paso.materiales.push(`${key.split(':')[1]}: ${cantidad} ${matColor}`);
        }
        // Sumar tiempo
        const tiempos = { dorado: 512, morado: 128, azul: 32, verde: 8, blanco: 2 };
        tiempoPaso += (tiempos[matColor] || 0) * cantidad;
      }
      paso.tiempo = tiempoPaso;
      rutaParcial.push(paso);
      tiempoAcumulado += tiempoPaso;
      // 2. Bifurcación: si el paso puede resultar en dos colores (ej: fabricar base morada o dorada)
      if (nivel == 1 && clase === 'Normal' && (color === 'morado' || color === 'dorado')) {
        // Simular "suerte": bifurcación
        let rutaMorado = JSON.parse(JSON.stringify(rutaParcial));
        let rutaDorado = JSON.parse(JSON.stringify(rutaParcial));
        let invMorado = JSON.parse(JSON.stringify(inventarioNuevo));
        let invDorado = JSON.parse(JSON.stringify(inventarioNuevo));
        let tMorado = tiempoAcumulado;
        let tDorado = tiempoAcumulado;
        // Morado
        rutaMorado[rutaMorado.length-1].bifurcacion = true;
        let resMorado = fabricarEquipo(clase, equipo, nivel+1, 'morado', invMorado, rutaMorado, tMorado);
        // Dorado
        rutaDorado[rutaDorado.length-1].bifurcacion = true;
        let resDorado = fabricarEquipo(clase, equipo, nivel+1, 'dorado', invDorado, rutaDorado, tDorado);
        rutas.push(resMorado);
        rutas.push(resDorado);
        return; // Terminar aquí para bifurcación
      }
      // 3. Si no es el nivel final, seguir con el siguiente nivel
      if (nivel < recetaFinal.nivel) {
        return fabricarEquipo(clase, equipo, nivel+1, color, inventarioNuevo, rutaParcial, tiempoAcumulado);
      }
      // 4. Si es el nivel final, terminar
      return { ruta: rutaParcial, inventario: inventarioNuevo, tiempo: tiempoAcumulado };
    }

    // Iniciar simulación desde nivel 1 blanco
    let resultado = fabricarEquipo('Normal', equipo, 1, 'blanco', inventario, [], 0);
    if (rutas.length === 0 && resultado) rutas.push(resultado);

    // Mostrar resultados
    const tbody = document.querySelector('.tbody-pasos');
    tbody.innerHTML = '';
    rutas.forEach((rutaObj, idx) => {
      rutaObj.ruta.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.paso}</td><td>${p.accion}</td><td colspan="2">${p.materiales.join(', ')}</td><td></td><td>${p.bifurcacion ? '¿Morado o Dorado?' : ''}</td><td></td>`;
        tbody.appendChild(tr);
      });
      // Fila resumen
      const trResumen = document.createElement('tr');
      trResumen.innerHTML = `<td colspan="7" style="background:#e0e1e6;font-weight:bold;">Ruta ${idx+1}: Tiempo total: ${formatearTiempo(rutaObj.tiempo)}</td>`;
      tbody.appendChild(trResumen);
    });
    // Inventario final
    const tbodyInv = document.querySelector('.tbody-inventario-final');
    tbodyInv.innerHTML = renderInventarioFinal();
    // Advertencias
    document.querySelector('.advertencias').innerHTML = advertencias.length ? '<b>Advertencias:</b><br>' + advertencias.join('<br>') : '';
  }

  // Lógica de importación de datos
  const btnCargar = document.getElementById('btn-cargar-datos');
  const fileRecetas = document.getElementById('file-recetas');
  const fileMateriales = document.getElementById('file-materiales');

  // Función toast
  function showToast(mensaje, tipo = 'info') {
    const toast = document.getElementById('toast');
    console.log('Toast:', mensaje, tipo); // Debug
    toast.textContent = mensaje;
    toast.style.display = 'block';
    toast.className = 'show';
    toast.style.background = tipo === 'success' ? '#43a047' : (tipo === 'error' ? '#c62828' : '#323232');
    toast.style.color = '#fff';
    setTimeout(() => {
      toast.className = '';
      setTimeout(()=>{toast.style.display='none';}, 400);
    }, 2600);
  }

  // Al cargar la página, NO renderizar controles ni simulación hasta que haya datos
  document.addEventListener('DOMContentLoaded', () => {
    showToast('Toast de prueba: la función está activa', 'info');
    // No renderControles ni renderSimulacion aquí
  });

  btnCargar.onclick = async () => {
    console.log('Click en btn-cargar-datos');
    showToast('Primero selecciona el archivo de RECETAS (.json), luego el de MATERIALES (.json)','info');
    fileRecetas.value = '';
    fileMateriales.value = '';
    fileRecetas.click();
  };

  fileRecetas.onchange = function(e) {
    console.log('fileRecetas.onchange');
    const file = e.target.files[0];
    if (!file) { console.log('No file en recetas'); return; }
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        let data = JSON.parse(evt.target.result);
        if (!Array.isArray(data)) {
          showToast('El archivo de recetas debe ser un array de recetas.','error');
          return;
        }
        // Guardar en memoria como array
        estado.recetas = data;
        // Ahora pedir materiales
        fileMateriales.value = '';
        fileMateriales.click();
        // Inicializar panel de bases
        initPanelBases();
      } catch (err) {
        showToast('Error al importar recetas: ' + err.message, 'error');
      }
    };
    reader.readAsText(file);
  };

  fileMateriales.onchange = function(e) {
    console.log('fileMateriales.onchange');
    const file = e.target.files[0];
    if (!file) { console.log('No file en materiales'); return; }
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        let data = JSON.parse(evt.target.result);
        if (!data.materiales || typeof data.materiales !== 'object') {
          showToast('El archivo de materiales debe tener una propiedad "materiales".','error');
          return;
        }
        // Guardar en memoria
        estado.almacenMateriales = data.materiales;
        // Contar colores por material
        let resumen = Object.entries(data.materiales).map(([nombre, colores]) => {
          let numColores = Object.values(colores).filter(v => Number(v) > 0).length;
          return `${nombre.split(':')[1]||nombre}: ${numColores} color(es)`;
        }).join(' | ');
        showToast('¡Datos importados correctamente! Ya puedes simular.\n' + resumen,'success');
        renderControles();
        // Inicializar panel de bases
        initPanelBases();
      } catch (err) {
        showToast('Error al importar materiales: ' + err.message, 'error');
      }
    };
    reader.readAsText(file);
  };

  // Inicializar selects de bases
  function initPanelBases() {
    // Usar solo los valores válidos para los selects
    const equipos = ['espada','pecho','botas','casco','guantes','cinturón'];
    const clases = ['Normal','Campeón','Planewalker','Lord','Noble Lord'];
    const niveles = ['1','2','3','4','5'];
    const colores = ['dorado','morado','azul','verde','blanco'];
    const selEquipo = document.getElementById('base-equipo');
    const selClase = document.getElementById('base-clase');
    const selNivel = document.getElementById('base-nivel');
    const selColor = document.getElementById('base-color');
    selEquipo.innerHTML = equipos.map(e=>`<option value='${e}'>${e.charAt(0).toUpperCase()+e.slice(1)}</option>`).join('');
    selClase.innerHTML = clases.map(c=>`<option value='${c}'>${c}</option>`).join('');
    selNivel.innerHTML = niveles.map(n=>`<option value='${n}'>${n}</option>`).join('');
    selColor.innerHTML = colores.map(c=>`<option value='${c}'>${c.charAt(0).toUpperCase()+c.slice(1)}</option>`).join('');
    document.getElementById('btn-agregar-base').onclick = () => {
      const base = {
        equipo: selEquipo.value,
        clase: selClase.value,
        nivel: selNivel.value,
        color: selColor.value
      };
      // Evitar duplicados
      if (!estado.basesUsuario.some(b=>b.equipo===base.equipo&&b.clase===base.clase&&b.nivel===base.nivel&&b.color===base.color)) {
        estado.basesUsuario.push(base);
        renderTablaBases();
        renderSimulacion();
      }
    };
    renderTablaBases();
  }
  function renderTablaBases() {
    const tbody = document.querySelector('#tabla-bases tbody');
    tbody.innerHTML = '';
    estado.basesUsuario.forEach((b,idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${b.equipo}</td><td>${b.clase}</td><td>${b.nivel}</td><td>${b.color.charAt(0).toUpperCase()+b.color.slice(1)}</td><td><button data-idx='${idx}' type='button'>Quitar</button></td>`;
      tr.querySelector('button').onclick = e => {
        estado.basesUsuario.splice(idx,1);
        renderTablaBases();
        renderSimulacion();
      };
      tbody.appendChild(tr);
    });
  }
  document.addEventListener('DOMContentLoaded', () => {
    initPanelBases();
    renderControles();
    renderSimulacion();
  });

  // Helper para obtener el inventario actual en formato {material: {color: cantidad, ...}, ...}
  function getInventarioActual() {
    const inventario = {};
    Object.keys(estado.almacenMateriales).forEach(key => {
      inventario[key] = { ...estado.almacenMateriales[key] };
    });
    return inventario;
  }
  </script>
</body>
</html> 