<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ruta Óptima de Producción - Deck Heroes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      color: #222;
      margin: 0;
      padding: 0;
    }
    .container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      width: 95vw;
      max-width: 900px;
      margin: 32px auto 0 auto;
      padding: 32px 18px 32px 18px;
    }
    h1 {
      text-align: center;
      color: #1e3a8a;
      margin-bottom: 8px;
    }
    .desc {
      text-align: center;
      color: #555;
      margin-bottom: 28px;
      font-size: 1.08em;
    }
    .panel {
      background: #f5f6fa;
      border-radius: 8px;
      padding: 18px 14px;
      margin-bottom: 18px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .panel-title {
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 8px;
      font-size: 1.1em;
    }
    .ruta-optima, .cronograma {
      min-height: 60px;
      color: #333;
      font-size: 1.08em;
    }
    .controles {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 18px;
    }
    .controles > * {
      font-size: 1em;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: #f5f6fa;
      color: #222;
      transition: background 0.2s;
      cursor: pointer;
    }
    .controles > *:hover {
      background: #e0e1e6;
    }
    @media (max-width: 600px) {
      .container { padding: 12px 2vw; }
      .panel { padding: 10px 4px; }
    }
    .simulacion-grid {
      display: grid;
      grid-template-columns: 3fr 2fr;
      gap: 24px;
      width: 90vw;
      max-width: 1200px;
      margin: 0 auto 32px auto;
      align-items: flex-start;
    }
    .simulacion-col {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 18px 14px 18px 14px;
      min-height: 320px;
    }
    .tabla-pasos {
      width: 100%;
      border-collapse: collapse;
      font-size: 1em;
      margin-bottom: 12px;
    }
    .tabla-pasos th, .tabla-pasos td {
      border: 1px solid #bbb;
      padding: 6px 8px;
      text-align: center;
    }
    .tabla-pasos th {
      background: #e0e1e6;
      color: #222;
    }
    .tabla-pasos tr:nth-child(even) {
      background: #f5f6fa;
    }
    .sugerencias-auto {
      margin-top: 10px;
      color: #1976d2;
      font-size: 1.01em;
    }
    .inventario-final-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.98em;
    }
    .inventario-final-table th, .inventario-final-table td {
      border: 1px solid #bbb;
      padding: 5px 7px;
      text-align: center;
    }
    .inventario-final-table th {
      background: #e0e1e6;
      color: #222;
    }
    .inventario-final-table tr:nth-child(even) {
      background: #f5f6fa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ruta Óptima de Producción</h1>
    <div class="desc">
      Aquí podrás ver la mejor secuencia de pasos para fabricar tu equipo, optimizando materiales y tiempo.<br>
      Próximamente: simulador interactivo, cronograma y sugerencias inteligentes.
    </div>
    <div class="controles">
      <!-- Aquí irán los controles para seleccionar objetivo, cargar inventario, etc. -->
      <button disabled>Seleccionar objetivo</button>
      <button disabled>Cargar inventario</button>
      <button disabled>Simular ruta óptima</button>
    </div>
    <div class="panel">
      <div class="panel-title">Ruta óptima sugerida</div>
      <div class="ruta-optima">
        <!-- Aquí se mostrará la ruta óptima paso a paso -->
        (Próximamente)
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">Cronograma estimado</div>
      <div class="cronograma">
        <!-- Aquí se mostrará el cronograma de producción -->
        (Próximamente)
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">Advertencias y sugerencias</div>
      <div class="sugerencias">
        <!-- Aquí se mostrarán advertencias, faltantes y tips -->
        (Próximamente)
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">Desmantelado de equipos</div>
      <div class="desmantelado">
        <!-- Aquí se mostrará la lógica de desmantelado y ahorro de tiempo -->
        (Próximamente)
      </div>
    </div>
    <div class="simulacion-grid">
      <div class="simulacion-col">
        <div style="font-weight:bold;font-size:1.12em;margin-bottom:8px;">Pasos de simulación</div>
        <table class="tabla-pasos">
          <thead>
            <tr>
              <th>Paso</th>
              <th>Base</th>
              <th>Nivel</th>
              <th>Color</th>
              <th>Materiales</th>
              <th>Resultado</th>
              <th>Éxito</th>
            </tr>
          </thead>
          <tbody class="tbody-pasos">
            <!-- Aquí se llenarán los pasos de la simulación -->
          </tbody>
        </table>
        <div class="sugerencias-auto">
          <!-- Aquí se mostrarán sugerencias automáticas -->
        </div>
      </div>
      <div class="simulacion-col">
        <div style="font-weight:bold;font-size:1.12em;margin-bottom:8px;">Inventario final tras la simulación</div>
        <table class="inventario-final-table">
          <thead>
            <tr>
              <th>Material</th>
              <th>Dorado</th>
              <th>Morado</th>
              <th>Azul</th>
              <th>Verde</th>
              <th>Blanco</th>
            </tr>
          </thead>
          <tbody class="tbody-inventario-final">
            <!-- Aquí se llenará el inventario final -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script type="module">
  import { cargarRecetasPersonalizadas, inicializarAlmacenamientoMateriales } from '../scripts/materiales.js';
  import { datosMateriales, mapaColores } from '../scripts/datos.js';

  // Estado global simple
  const estado = {
    materialesData: datosMateriales,
    almacenMateriales: {},
    recetas: {},
    recetaFinalKey: '',
  };

  // Verificar si ya hay recetas/materiales cargados
  let recetasCargadas = false;
  try {
    const r = cargarRecetasPersonalizadas();
    if (r && Object.keys(r).length > 0) {
      estado.recetas = r;
      recetasCargadas = true;
    }
  } catch {}
  if (!recetasCargadas) {
    inicializarAlmacenamientoMateriales(estado);
    estado.recetas = cargarRecetasPersonalizadas();
  }

  function getRecetasFinalesDisponibles() {
    return Object.keys(estado.recetas).filter(k => {
      const r = estado.recetas[k];
      return ['Campeón','Planewalker','Lord','Noble Lord'].includes(r.clase);
    });
  }

  function formatearNombreReceta(key) {
    const r = estado.recetas[key];
    if (!r) return key;
    return `${r.clase} ${r.color.charAt(0).toUpperCase()+r.color.slice(1)} (${r.equipo}, Nivel ${r.nivel}, Base: ${r.base})`;
  }

  function renderControles() {
    const controles = document.querySelector('.controles');
    controles.innerHTML = '';
    const selectReceta = document.createElement('select');
    selectReceta.style.minWidth = '260px';
    const opciones = getRecetasFinalesDisponibles();
    if (opciones.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No hay recetas finales cargadas';
      selectReceta.appendChild(opt);
      selectReceta.disabled = true;
    } else {
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Selecciona receta final...';
      selectReceta.appendChild(opt0);
      opciones.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = formatearNombreReceta(k);
        if (k === estado.recetaFinalKey) opt.selected = true;
        selectReceta.appendChild(opt);
      });
    }
    selectReceta.onchange = e => { estado.recetaFinalKey = e.target.value; renderTodo(); };
    controles.appendChild(selectReceta);
  }

  function renderInventario() {
    let html = '<table style="width:100%;font-size:0.98em;margin-bottom:8px;"><thead><tr><th>Material</th><th>Dorado</th><th>Morado</th><th>Azul</th><th>Verde</th><th>Blanco</th></tr></thead><tbody>';
    Object.keys(estado.almacenMateriales).forEach(key => {
      const mat = key.split(':')[1];
      html += `<tr><td>${mat}</td>`;
      ['dorado','morado','azul','verde','blanco'].forEach(c => {
        html += `<td>${estado.almacenMateriales[key][c]}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
  }

  function calcularRutaYTiempo(recetaKey) {
    if (!recetaKey || !estado.recetas[recetaKey]) return { pasos: [], tiempoTotal: 0, advertencias: ['Selecciona una receta final válida.'] };
    const recetaFinal = estado.recetas[recetaKey];
    let pasos = [];
    let advertencias = [];
    let tiempoTotal = 0;
    let secuencia = [];
    // 1. Recetas normales de nivel 1 (blanco, luego morado, luego dorado)
    for (const color of ['blanco','morado','dorado']) {
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '1' && r.color === color && r.equipo === recetaFinal.equipo;
      });
      if (k) secuencia.push(k);
      else advertencias.push(`Falta receta: Normal 1 ${color}`);
    }
    // 2. Niveles 2, 3, 4 (dorado)
    for (let n = 2; n <= 4; n++) {
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === String(n) && r.color === 'dorado' && r.equipo === recetaFinal.equipo;
      });
      if (k) secuencia.push(k);
      else advertencias.push(`Falta receta: Normal ${n} dorado`);
    }
    // 3. Lógica de base según clase avanzada
    let baseMsg = '';
    if (recetaFinal.clase === 'Planewalker') {
      // Base: equipo Normal de nivel 5 y del mismo tipo
      baseMsg = `Base requerida: ${recetaFinal.equipo} Normal nivel 5 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '5' && r.equipo === recetaFinal.equipo;
      });
      if (k) secuencia.push(k);
      else advertencias.push(`Falta receta base: Normal 5 (${recetaFinal.equipo})`);
    } else if (recetaFinal.clase === 'Lord') {
      // Base: equipo Normal de nivel 5, cualquier tipo
      baseMsg = `Base requerida: cualquier equipo Normal nivel 5 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '5';
      });
      if (!k) advertencias.push(`Falta receta base: Normal 5 (cualquier equipo)`);
    } else if (recetaFinal.clase === 'Noble Lord') {
      // Base: equipo Lord de nivel 5, cualquier tipo
      baseMsg = `Base requerida: cualquier equipo Lord nivel 5 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Lord' && r.nivel === '5';
      });
      if (!k) advertencias.push(`Falta receta base: Lord 5 (cualquier equipo)`);
    } else if (recetaFinal.clase === 'Campeón') {
      // Base: equipo Normal de nivel 4 y mismo tipo
      baseMsg = `Base requerida: ${recetaFinal.equipo} Normal nivel 4 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '4' && r.equipo === recetaFinal.equipo;
      });
      if (!k) advertencias.push(`Falta receta base: Normal 4 (${recetaFinal.equipo})`);
    }
    // 4. Receta final
    secuencia.push(recetaKey);
    // Procesar cada paso
    for (const k of secuencia) {
      const r = estado.recetas[k];
      if (!r) continue;
      const tiempos = { dorado: 512, morado: 128, azul: 32, verde: 8, blanco: 2 };
      let tiempo = 0;
      Object.entries(r.materiales).forEach(([col, cant]) => {
        tiempo += (tiempos[col] || 0) * (cant || 0);
      });
      tiempoTotal += tiempo;
      pasos.push({
        nombre: formatearNombreReceta(k),
        materiales: r.materiales,
        tiempo,
        tasaExito: r.tasaExito || r.porcentaje || 100
      });
    }
    return { pasos, tiempoTotal, advertencias, baseMsg };
  }

  function formatearTiempo(horas) {
    if (!horas || isNaN(horas)) return '0h';
    const meses = Math.floor(horas / (30*24));
    let resto = horas % (30*24);
    const semanas = Math.floor(resto / (7*24));
    resto = resto % (7*24);
    const dias = Math.floor(resto / 24);
    const h = resto % 24;
    let partes = [];
    if (meses) partes.push(`${meses} mes${meses>1?'es':''}`);
    if (semanas) partes.push(`${semanas} semana${semanas>1?'s':''}`);
    if (dias) partes.push(`${dias} día${dias>1?'s':''}`);
    if (h) partes.push(`${h} h`);
    return partes.join(', ') || '0h';
  }

  function renderDesmantelado() {
    // Solo implementado para equipo dorado de nivel 1
    // Tiempo fabricar equipo dorado de nivel 1: 388h
    // Tiempo fabricar 1 material dorado desde cero: 512h
    // Ahorro: 124h
    let html = `<b>Desmantelado de equipo dorado de nivel 1</b><br>`;
    html += `Si fabricas un equipo dorado de nivel 1 (<b>388h</b>) y lo desmantelas, obtienes 1 material dorado al azar (de los 2 usados en la receta).<br>`;
    html += `Si el material obtenido es el que necesitas, <b>te ahorras 124 horas</b> respecto a fabricarlo desde cero (<b>512h</b>).`;
    html += `<br><span style='color:#888;font-size:0.98em;'>(Esta mecánica puede cambiar para otros niveles. Por ahora, solo está confirmada para nivel 1. Para nivel 5, se cree que da 2 materiales, pero no está confirmado.)</span>`;
    document.querySelector('.desmantelado').innerHTML = html;
  }

  const oldRenderTodo = renderTodo;
  renderTodo = function() {
    oldRenderTodo();
    renderDesmantelado();
  };

  document.addEventListener('DOMContentLoaded', renderTodo);
  </script>
</body>
</html> 