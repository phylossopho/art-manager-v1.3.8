<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ruta Óptima de Producción - Deck Heroes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      color: #222;
      margin: 0;
      padding: 0;
    }
    .container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      width: 95vw;
      max-width: 900px;
      margin: 32px auto 0 auto;
      padding: 32px 18px 32px 18px;
    }
    h1 {
      text-align: center;
      color: #1e3a8a;
      margin-bottom: 8px;
    }
    .desc {
      text-align: center;
      color: #555;
      margin-bottom: 28px;
      font-size: 1.08em;
    }
    .panel {
      background: #f5f6fa;
      border-radius: 8px;
      padding: 18px 14px;
      margin-bottom: 18px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .panel-title {
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 8px;
      font-size: 1.1em;
    }
    .ruta-optima, .cronograma {
      min-height: 60px;
      color: #333;
      font-size: 1.08em;
    }
    .controles {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 18px;
    }
    .controles > * {
      font-size: 1em;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: #f5f6fa;
      color: #222;
      transition: background 0.2s;
      cursor: pointer;
    }
    .controles > *:hover {
      background: #e0e1e6;
    }
    @media (max-width: 600px) {
      .container { padding: 12px 2vw; }
      .panel { padding: 10px 4px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ruta Óptima de Producción</h1>
    <div class="desc">
      Aquí podrás ver la mejor secuencia de pasos para fabricar tu equipo, optimizando materiales y tiempo.<br>
      Próximamente: simulador interactivo, cronograma y sugerencias inteligentes.
    </div>
    <div class="controles">
      <!-- Aquí irán los controles para seleccionar objetivo, cargar inventario, etc. -->
      <button disabled>Seleccionar objetivo</button>
      <button disabled>Cargar inventario</button>
      <button disabled>Simular ruta óptima</button>
    </div>
    <div class="panel">
      <div class="panel-title">Ruta óptima sugerida</div>
      <div class="ruta-optima">
        <!-- Aquí se mostrará la ruta óptima paso a paso -->
        (Próximamente)
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">Cronograma estimado</div>
      <div class="cronograma">
        <!-- Aquí se mostrará el cronograma de producción -->
        (Próximamente)
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">Advertencias y sugerencias</div>
      <div class="sugerencias">
        <!-- Aquí se mostrarán advertencias, faltantes y tips -->
        (Próximamente)
      </div>
    </div>
  </div>
  <script type="module">
  import { cargarRecetasPersonalizadas, inicializarAlmacenamientoMateriales } from '../scripts/materiales.js';
  import { datosMateriales, mapaColores } from '../scripts/datos.js';

  // Estado global simple
  const estado = {
    materialesData: datosMateriales,
    almacenMateriales: {},
    recetas: {},
    recetaFinalKey: '',
  };

  // Verificar si ya hay recetas/materiales cargados
  let recetasCargadas = false;
  try {
    const r = cargarRecetasPersonalizadas();
    if (r && Object.keys(r).length > 0) {
      estado.recetas = r;
      recetasCargadas = true;
    }
  } catch {}
  if (!recetasCargadas) {
    inicializarAlmacenamientoMateriales(estado);
    estado.recetas = cargarRecetasPersonalizadas();
  }

  function getRecetasFinalesDisponibles() {
    return Object.keys(estado.recetas).filter(k => {
      const r = estado.recetas[k];
      return ['Campeón','Planewalker','Lord','Noble Lord'].includes(r.clase);
    });
  }

  function formatearNombreReceta(key) {
    const r = estado.recetas[key];
    if (!r) return key;
    return `${r.clase} ${r.color.charAt(0).toUpperCase()+r.color.slice(1)} (${r.equipo}, Nivel ${r.nivel}, Base: ${r.base})`;
  }

  function renderControles() {
    const controles = document.querySelector('.controles');
    controles.innerHTML = '';
    const selectReceta = document.createElement('select');
    selectReceta.style.minWidth = '260px';
    const opciones = getRecetasFinalesDisponibles();
    if (opciones.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No hay recetas finales cargadas';
      selectReceta.appendChild(opt);
      selectReceta.disabled = true;
    } else {
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Selecciona receta final...';
      selectReceta.appendChild(opt0);
      opciones.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = formatearNombreReceta(k);
        if (k === estado.recetaFinalKey) opt.selected = true;
        selectReceta.appendChild(opt);
      });
    }
    selectReceta.onchange = e => { estado.recetaFinalKey = e.target.value; renderTodo(); };
    controles.appendChild(selectReceta);
  }

  function renderInventario() {
    let html = '<table style="width:100%;font-size:0.98em;margin-bottom:8px;"><thead><tr><th>Material</th><th>Dorado</th><th>Morado</th><th>Azul</th><th>Verde</th><th>Blanco</th></tr></thead><tbody>';
    Object.keys(estado.almacenMateriales).forEach(key => {
      const mat = key.split(':')[1];
      html += `<tr><td>${mat}</td>`;
      ['dorado','morado','azul','verde','blanco'].forEach(c => {
        html += `<td>${estado.almacenMateriales[key][c]}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
  }

  function calcularRutaYTiempo(recetaKey) {
    if (!recetaKey || !estado.recetas[recetaKey]) return { pasos: [], tiempoTotal: 0, advertencias: ['Selecciona una receta final válida.'] };
    const recetaFinal = estado.recetas[recetaKey];
    let pasos = [];
    let advertencias = [];
    let tiempoTotal = 0;
    let secuencia = [];
    // 1. Recetas normales de nivel 1 (blanco, luego morado, luego dorado)
    for (const color of ['blanco','morado','dorado']) {
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '1' && r.color === color && r.equipo === recetaFinal.equipo;
      });
      if (k) secuencia.push(k);
      else advertencias.push(`Falta receta: Normal 1 ${color}`);
    }
    // 2. Niveles 2, 3, 4 (dorado)
    for (let n = 2; n <= 4; n++) {
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === String(n) && r.color === 'dorado' && r.equipo === recetaFinal.equipo;
      });
      if (k) secuencia.push(k);
      else advertencias.push(`Falta receta: Normal ${n} dorado`);
    }
    // 3. Lógica de base según clase avanzada
    let baseMsg = '';
    if (recetaFinal.clase === 'Planewalker') {
      // Base: equipo Normal de nivel 5 y del mismo tipo
      baseMsg = `Base requerida: ${recetaFinal.equipo} Normal nivel 5 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '5' && r.equipo === recetaFinal.equipo;
      });
      if (k) secuencia.push(k);
      else advertencias.push(`Falta receta base: Normal 5 (${recetaFinal.equipo})`);
    } else if (recetaFinal.clase === 'Lord') {
      // Base: equipo Normal de nivel 5, cualquier tipo
      baseMsg = `Base requerida: cualquier equipo Normal nivel 5 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '5';
      });
      if (!k) advertencias.push(`Falta receta base: Normal 5 (cualquier equipo)`);
    } else if (recetaFinal.clase === 'Noble Lord') {
      // Base: equipo Lord de nivel 5, cualquier tipo
      baseMsg = `Base requerida: cualquier equipo Lord nivel 5 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Lord' && r.nivel === '5';
      });
      if (!k) advertencias.push(`Falta receta base: Lord 5 (cualquier equipo)`);
    } else if (recetaFinal.clase === 'Campeón') {
      // Base: equipo Normal de nivel 4 y mismo tipo
      baseMsg = `Base requerida: ${recetaFinal.equipo} Normal nivel 4 (cualquier color)`;
      const k = Object.keys(estado.recetas).find(k => {
        const r = estado.recetas[k];
        return r.clase === 'Normal' && r.nivel === '4' && r.equipo === recetaFinal.equipo;
      });
      if (!k) advertencias.push(`Falta receta base: Normal 4 (${recetaFinal.equipo})`);
    }
    // 4. Receta final
    secuencia.push(recetaKey);
    // Procesar cada paso
    for (const k of secuencia) {
      const r = estado.recetas[k];
      if (!r) continue;
      const tiempos = { dorado: 512, morado: 128, azul: 32, verde: 8, blanco: 2 };
      let tiempo = 0;
      Object.entries(r.materiales).forEach(([col, cant]) => {
        tiempo += (tiempos[col] || 0) * (cant || 0);
      });
      tiempoTotal += tiempo;
      pasos.push({
        nombre: formatearNombreReceta(k),
        materiales: r.materiales,
        tiempo,
        tasaExito: r.tasaExito || r.porcentaje || 100
      });
    }
    return { pasos, tiempoTotal, advertencias, baseMsg };
  }

  function formatearTiempo(horas) {
    if (!horas || isNaN(horas)) return '0h';
    const meses = Math.floor(horas / (30*24));
    let resto = horas % (30*24);
    const semanas = Math.floor(resto / (7*24));
    resto = resto % (7*24);
    const dias = Math.floor(resto / 24);
    const h = resto % 24;
    let partes = [];
    if (meses) partes.push(`${meses} mes${meses>1?'es':''}`);
    if (semanas) partes.push(`${semanas} semana${semanas>1?'s':''}`);
    if (dias) partes.push(`${dias} día${dias>1?'s':''}`);
    if (h) partes.push(`${h} h`);
    return partes.join(', ') || '0h';
  }

  function renderTodo() {
    renderControles();
    document.querySelector('.panel-inventario').innerHTML = '<div style="font-weight:bold;margin-bottom:6px;">Inventario actual</div>' + renderInventario();
    const { pasos, tiempoTotal, advertencias, baseMsg } = calcularRutaYTiempo(estado.recetaFinalKey);
    let rutaHtml = '';
    if (!pasos.length) {
      rutaHtml = `<span style='color:#c00;'>Selecciona una receta final válida.</span>`;
    } else {
      rutaHtml = '<ol style="margin:8px 0 0 0;padding-left:18px;">';
      pasos.forEach((p, i) => {
        rutaHtml += `<li><b>${p.nombre}</b> | Materiales: ${Object.entries(p.materiales).filter(([_,v])=>v>0).map(([c,v])=>`${v} ${c}`).join(', ')} | Éxito: ${p.tasaExito}% | Tiempo: <span style='color:#888;'>${formatearTiempo(p.tiempo)}</span></li>`;
      });
      rutaHtml += '</ol>';
    }
    document.querySelector('.ruta-optima').innerHTML = rutaHtml;
    document.querySelector('.cronograma').innerHTML = `<b>Tiempo total estimado:</b> <span style='color:#1976d2;font-size:1.2em;'>${formatearTiempo(tiempoTotal)}</span> (${tiempoTotal} horas)`;
    let sugHtml = '';
    if (baseMsg) {
      sugHtml += `<div style='color:#1976d2;font-weight:bold;margin-bottom:6px;'>${baseMsg}</div>`;
    }
    if (advertencias.length) {
      sugHtml += '<ul style="color:#c00;">';
      advertencias.forEach(a => { sugHtml += `<li>${a}</li>`; });
      sugHtml += '</ul>';
    } else if (baseMsg) {
      sugHtml += '<span style="color:#43a047;">Todo listo para fabricar el equipo final.</span>';
    }
    document.querySelector('.sugerencias').innerHTML = sugHtml;
  }

  document.addEventListener('DOMContentLoaded', renderTodo);
  </script>
</body>
</html> 