<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experimento Recetas DH</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6fa; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 24px; }
        h1 { color: #1e3a8a; text-align: center; margin-bottom: 18px; }
        table { border-collapse: collapse; width: 100%; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 8px 6px; text-align: center; font-size: 1em; }
        th { background: #e3eafc; color: #1e3a8a; }
        tr:nth-child(even) { background: #f7faff; }
        .agregar-btn { background: #2196F3; color: #fff; border: none; border-radius: 6px; padding: 10px 24px; font-size: 1.1em; cursor: pointer; margin: 18px 0; }
        .agregar-btn:hover { background: #1769aa; }
        .filtros { margin: 18px 0 10px 0; display: flex; gap: 18px; align-items: center; }
        .filtros label { font-weight: bold; }
        .inline-selects { display: flex; gap: 12px; align-items: center; }
        fieldset { border: 1px solid #bbb; border-radius: 8px; margin-bottom: 12px; padding: 10px 16px; }
        legend { color: #1e3a8a; font-weight: bold; }
        .circle-color { display: inline-block; width: 18px; height: 18px; border-radius: 50%; border: 2px solid #bbb; margin: 0 2px; }
        .backdrop-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
<div class="container">
    <h1>Gestor de Recetas - Experimento</h1>
    <form id="receta-form">
        <fieldset>
            <legend>Equipo</legend>
            <div class="inline-selects">
                <label for="clase">Clase:</label>
                <select id="clase">
                    <option value="Normal">Normal</option>
                    <option value="Campeón">Campeón</option>
                    <option value="Planewalker">Planewalker</option>
                    <option value="Lord">Lord</option>
                    <option value="Noble Lord">Noble Lord</option>
                </select>
                <label for="nivel">Nivel:</label>
                <select id="nivel">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <label for="color">Color:</label>
                <select id="color">
                    <option value="blanco">Blanco</option>
                    <option value="verde">Verde</option>
                    <option value="azul">Azul</option>
                    <option value="morado">Morado</option>
                    <option value="dorado">Dorado</option>
                </select>
            </div>
        </fieldset>
        <fieldset>
            <legend>Materiales</legend>
            <div class="inline-selects">
                <label>Dorado: <input type="number" class="color-material" min="0" value="0" style="width:50px;"></label>
                <label>Morado: <input type="number" class="color-material" min="0" value="0" style="width:50px;"></label>
                <label>Azul: <input type="number" class="color-material" min="0" value="0" style="width:50px;"></label>
                <label>Verde: <input type="number" class="color-material" min="0" value="0" style="width:50px;"></label>
                <label>Blanco: <input type="number" class="color-material" min="0" value="0" style="width:50px;"></label>
            </div>
        </fieldset>
        <fieldset>
            <legend>Base</legend>
            <div class="inline-selects">
                <label for="base-clase">Clase:</label>
                <select id="base-clase">
                    <option value="">-</option>
                    <option value="Normal">Normal</option>
                    <option value="Campeón">Campeón</option>
                    <option value="Planewalker">Planewalker</option>
                    <option value="Lord">Lord</option>
                    <option value="Noble Lord">Noble Lord</option>
                </select>
                <label for="base-nivel">Nivel:</label>
                <select id="base-nivel">
                    <option value="">-</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <label for="base-color">Color:</label>
                <select id="base-color">
                    <option value="">-</option>
                    <option value="blanco">Blanco</option>
                    <option value="verde">Verde</option>
                    <option value="azul">Azul</option>
                    <option value="morado">Morado</option>
                    <option value="dorado">Dorado</option>
                </select>
            </div>
        </fieldset>
        <fieldset>
            <legend>Éxito</legend>
            <div class="inline-selects">
                <label for="porcentaje">Porcentaje:</label>
                <input id="porcentaje" type="number" min="0" max="100" step="0.01" placeholder="0.00" required style="width:100px;">
            </div>
        </fieldset>
        <button type="submit" class="agregar-btn" form="receta-form">Agregar receta</button>
    </form>
    <div class="filtros">
        <label for="filtro-clase">Filtrar clase:</label>
        <select id="filtro-clase">
            <option value="">Todas</option>
            <option value="Normal">Normal</option>
            <option value="Campeón">Campeón</option>
            <option value="Planewalker">Planewalker</option>
            <option value="Lord">Lord</option>
            <option value="Noble Lord">Noble Lord</option>
        </select>
        <label for="filtro-nivel">Nivel:</label>
        <select id="filtro-nivel">
            <option value="">Todos</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
    </div>
    <table id="tabla-recetas" style="display:none;">
        <thead>
            <tr>
                <th rowspan="2">#</th>
                <th colspan="8">Equipo</th>
                <th colspan="3">Base</th>
                <th rowspan="2">Éxito</th>
                <th rowspan="2">Acciones</th>
            </tr>
            <tr>
                <th>Clase</th>
                <th>Nivel</th>
                <th>Color</th>
                <th>Dorado</th>
                <th>Morado</th>
                <th>Azul</th>
                <th>Verde</th>
                <th>Blanco</th>
                <th>Clase</th>
                <th>Nivel</th>
                <th>Color</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div style="display:flex;gap:12px;justify-content:center;margin:18px 0 0 0;">
        <button id="guardar-recetas" style="display:none;padding:10px 24px;font-size:1rem;background:#43a047;color:#fff;border:none;border-radius:6px;cursor:pointer;">Guardar recetas</button>
        <button id="agregar-receta-tiempo" style="padding:10px 24px;font-size:1rem;background:#1e3a8a;color:#fff;border:none;border-radius:6px;cursor:pointer;">+ Agregar receta</button>
    </div>
</div>
<div id="modal-confirm-borrar" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:28px 24px 18px 24px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.18);max-width:320px;text-align:center;">
    <div style="font-size:1.15rem;margin-bottom:18px;">¿Seguro que deseas borrar esta receta?</div>
    <button id="confirm-borrar-aceptar" style="background:#43a047;color:#fff;font-size:1.2rem;padding:8px 18px;margin:0 10px 0 0;border:none;border-radius:6px;cursor:pointer;">Aceptar ✅</button>
    <button id="confirm-borrar-cancelar" style="background:#e53935;color:#fff;font-size:1.2rem;padding:8px 18px;border:none;border-radius:6px;cursor:pointer;">NO ❌</button>
  </div>
</div>
<script>
const form = document.getElementById('receta-form');
const tabla = document.getElementById('tabla-recetas');
const tbody = tabla.querySelector('tbody');
let recetas = [];
let editIndex = null; // Índice de la receta que se está editando
let borrarIndex = null;
const agregarBtn = document.querySelector('.agregar-btn');

function resetFormularioUI() {
    form.reset();
    document.getElementById('base-clase').value = '';
    document.getElementById('base-nivel').value = '';
    document.getElementById('base-color').value = '';
    agregarBtn.textContent = 'Agregar receta';
    agregarBtn.style.background = '#2196F3';
    editIndex = null;
    aplicarRestricciones();
}

form.onsubmit = function(e) {
    e.preventDefault();
    const clase = document.getElementById('clase').value;
    const nivel = document.getElementById('nivel').value;
    const color = document.getElementById('color').value;
    const porcentaje = parseFloat(document.getElementById('porcentaje').value).toFixed(2);
    // Obtener cantidades de materiales
    const materiales = {
        dorado: parseInt(document.querySelectorAll('.color-material')[0].value),
        morado: parseInt(document.querySelectorAll('.color-material')[1].value),
        azul: parseInt(document.querySelectorAll('.color-material')[2].value),
        verde: parseInt(document.querySelectorAll('.color-material')[3].value),
        blanco: parseInt(document.querySelectorAll('.color-material')[4].value)
    };
    // Verificar que al menos un material tenga cantidad > 0
    const totalMateriales = Object.values(materiales).reduce((sum, val) => sum + val, 0);
    if (totalMateriales === 0) {
        alert('Debes seleccionar al menos un material.');
        return;
    }
    if (totalMateriales > 4) {
        alert('No puedes seleccionar más de 4 materiales en total.');
        return;
    }
    // Obtener datos de la base
    const baseClase = document.getElementById('base-clase').value;
    const baseNivel = document.getElementById('base-nivel').value;
    const baseColor = document.getElementById('base-color').value;
    const base = baseClase ? {
        clase: baseClase,
        nivel: baseNivel,
        color: baseColor
    } : null;
    const nuevaReceta = { clase, nivel, color, porcentaje, materiales, base };
    if (editIndex !== null) {
        recetas[editIndex] = nuevaReceta;
    } else {
        recetas.push(nuevaReceta);
    }
    renderTabla();
    resetFormularioUI();
};

document.getElementById('filtro-clase').onchange = renderTabla;
document.getElementById('filtro-nivel').onchange = renderTabla;

document.getElementById('guardar-recetas').onclick = function() {
    if (recetas.length === 0) return;
    const dataStr = JSON.stringify(recetas, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'recetas.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

function renderTabla() {
    const filtroClase = document.getElementById('filtro-clase').value;
    const filtroNivel = document.getElementById('filtro-nivel').value;
    let recetasFiltradas = recetas;
    if (filtroClase) {
        recetasFiltradas = recetasFiltradas.filter(r => r.clase === filtroClase);
    }
    if (filtroNivel) {
        recetasFiltradas = recetasFiltradas.filter(r => r.nivel === filtroNivel);
    }
    // Ordenar por clase, nivel, color (jerarquía), número de materiales (jerarquía)
    const colorOrden = { dorado: 5, morado: 4, azul: 3, verde: 2, blanco: 1 };
    const claseOrden = { 'Normal': 1, 'Campeón': 2, 'Planewalker': 3, 'Lord': 4, 'Noble Lord': 5 };
    recetasFiltradas = recetasFiltradas.slice().sort((a, b) => {
        // 1. Clase (jerarquía definida)
        const claseA = claseOrden[a.clase] || 99;
        const claseB = claseOrden[b.clase] || 99;
        if (claseA !== claseB) return claseA - claseB;
        // 2. Nivel (numérico ascendente)
        const nivelA = parseInt(a.nivel);
        const nivelB = parseInt(b.nivel);
        if (nivelA !== nivelB) return nivelA - nivelB;
        // 3. Color (jerarquía)
        const colorA = colorOrden[a.color] || 0;
        const colorB = colorOrden[b.color] || 0;
        if (colorA !== colorB) return colorB - colorA;
        // 4. Número de materiales por jerarquía (ponderado)
        const sumaA = Object.entries(a.materiales).reduce((acc, [col, val]) => acc + (colorOrden[col] || 0) * (val || 0), 0);
        const sumaB = Object.entries(b.materiales).reduce((acc, [col, val]) => acc + (colorOrden[col] || 0) * (val || 0), 0);
        return sumaB - sumaA;
    });
    if (recetasFiltradas.length === 0) {
        tabla.style.display = 'none';
        document.getElementById('guardar-recetas').style.display = 'none';
        return;
    }
    tabla.style.display = '';
    document.getElementById('guardar-recetas').style.display = 'block';
    tbody.innerHTML = '';
    recetasFiltradas.forEach((receta, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${receta.clase}</td>
            <td>${receta.nivel}</td>
            <td>${receta.color}</td>
            <td>${receta.materiales.dorado}</td>
            <td>${receta.materiales.morado}</td>
            <td>${receta.materiales.azul}</td>
            <td>${receta.materiales.verde}</td>
            <td>${receta.materiales.blanco}</td>
            <td>${receta.base ? receta.base.clase : ''}</td>
            <td>${receta.base ? receta.base.nivel : ''}</td>
            <td>${receta.base ? receta.base.color : ''}</td>
            <td>${receta.porcentaje}%</td>
            <td>
                <button class="editar-btn" title="Editar" style="background:none;border:none;cursor:pointer;font-size:1.2em;">✏️</button>
                <button class="borrar-btn" title="Borrar" style="background:none;border:none;cursor:pointer;font-size:1.2em;">🗑️</button>
            </td>
        `;
        // Acciones borrar y editar
        tr.querySelector('.borrar-btn').onclick = () => {
            borrarIndex = recetas.indexOf(recetasFiltradas[idx]);
            document.getElementById('modal-confirm-borrar').style.display = 'flex';
        };
        tr.querySelector('.editar-btn').onclick = () => {
            // Cargar los datos de la receta en el formulario para editar
            const r = recetasFiltradas[idx];
            document.getElementById('clase').value = r.clase;
            document.getElementById('color').value = r.color;
            document.getElementById('porcentaje').value = r.porcentaje;
            document.querySelectorAll('.color-material')[0].value = r.materiales.dorado;
            document.querySelectorAll('.color-material')[1].value = r.materiales.morado;
            document.querySelectorAll('.color-material')[2].value = r.materiales.azul;
            document.querySelectorAll('.color-material')[3].value = r.materiales.verde;
            document.querySelectorAll('.color-material')[4].value = r.materiales.blanco;
            if (r.base) {
                document.getElementById('base-clase').value = r.base.clase;
                document.getElementById('base-nivel').value = r.base.nivel;
                document.getElementById('base-color').value = r.base.color;
            } else {
                document.getElementById('base-clase').value = '';
                document.getElementById('base-nivel').value = '';
                document.getElementById('base-color').value = '';
            }
            document.getElementById('nivel').value = r.nivel;
            aplicarRestricciones();
            // Guardar el índice real de la receta que se está editando
            editIndex = recetas.indexOf(recetasFiltradas[idx]);
            agregarBtn.textContent = 'Modificar receta';
            agregarBtn.style.background = '#ff9800';
        };
        tbody.appendChild(tr);
    });
    // Mostrar/ocultar botones de guardar/importar
    document.getElementById('guardar-recetas').style.display = recetas.length ? 'block' : 'none';
    document.getElementById('importar-recetas').style.display = 'block';
}

const TIEMPOS_MATERIAL = { dorado: 512, morado: 128, azul: 32, verde: 8, blanco: 2 };
let recetasTiempoSeleccion = {};

document.getElementById('agregar-receta-tiempo').onclick = abrirModalSeleccionRecetas;

function abrirModalSeleccionRecetas() {
  // Obtener recetas normales
  const recetasNormales = recetas.map((r, idx) => ({...r, idx})).filter(r => r.clase === 'Normal');
  if (recetasNormales.length === 0) return;
  // Inicializar selección si está vacía
  if (!recetasTiempoSeleccion || typeof recetasTiempoSeleccion !== 'object') recetasTiempoSeleccion = {};
  // Modal
  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.top = '0';
  modal.style.left = '0';
  modal.style.width = '100vw';
  modal.style.height = '100vh';
  modal.style.background = 'rgba(0,0,0,0.6)';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.zIndex = '9999';
  // Contenido
  const inner = document.createElement('div');
  inner.style.background = '#fff';
  inner.style.padding = '28px 18px 18px 18px';
  inner.style.borderRadius = '12px';
  inner.style.boxShadow = '0 4px 16px rgba(0,0,0,0.18)';
  inner.style.textAlign = 'center';
  inner.style.maxWidth = '98vw';
  inner.style.width = 'min(600px,98vw)';
  inner.style.maxHeight = '90vh';
  inner.style.overflowY = 'auto';
  // Tabla
  let tabla = `<table id='tabla-modal-recetas-tiempo' style='width:100%;margin-bottom:18px;font-size:1rem;'><thead><tr><th>Nivel</th><th>Color</th><th>Materiales</th><th>% Éxito</th><th colspan='3'>Acciones</th></tr></thead><tbody>`;
  recetasNormales.forEach(r => {
    const materialesStr = Object.entries(r.materiales)
      .filter(([color, cantidad]) => cantidad > 0)
      .map(([color, cantidad]) => `${cantidad} ${color}${cantidad > 1 ? 's' : ''}`)
      .join(', ');
    const cantidad = recetasTiempoSeleccion[r.idx] || 0;
    const desvanecido = cantidad > 0;
    tabla += `<tr data-idx='${r.idx}' style='${desvanecido ? "color:rgba(80,80,80,0.66);" : ""}'>`;
    tabla += `<td>${r.nivel}</td>`;
    tabla += `<td>${r.color.charAt(0).toUpperCase() + r.color.slice(1)}</td>`;
    tabla += `<td>${materialesStr}</td>`;
    tabla += `<td>${parseFloat(r.porcentaje).toFixed(2)}%</td>`;
    tabla += `<td><button class='btn-mas' data-idx='${r.idx}' style='font-size:1.5em;padding:8px 18px;margin:0 10px;background:#43a047;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:opacity 0.2s;${desvanecido ? "opacity:0.3;pointer-events:none;" : ""}'>+</button></td>`;
    tabla += `<td><button class='btn-menos' data-idx='${r.idx}' style='font-size:1.5em;padding:8px 18px;margin:0 10px;background:#e53935;color:#fff;border:none;border-radius:8px;cursor:pointer;'>-</button></td>`;
    tabla += `<td style='font-weight:bold;font-size:1.1em;'>${cantidad > 0 ? cantidad : ''}</td>`;
    tabla += `</tr>`;
  });
  tabla += `</tbody></table>`;
  // Resumen de tiempo
  const resumenDiv = document.createElement('div');
  resumenDiv.id = 'modal-resumen-tiempo-recetas';
  resumenDiv.style.margin = '12px 0 18px 0';
  resumenDiv.style.fontSize = '1.08em';
  // Botón cerrar
  const cerrar = document.createElement('button');
  cerrar.textContent = 'Cerrar';
  cerrar.style.background = '#1e3a8a';
  cerrar.style.color = '#fff';
  cerrar.style.border = 'none';
  cerrar.style.borderRadius = '8px';
  cerrar.style.padding = '8px 24px';
  cerrar.style.fontSize = '1.1em';
  cerrar.style.marginTop = '10px';
  cerrar.style.cursor = 'pointer';
  cerrar.onclick = function() {
    document.body.removeChild(modal);
  };
  inner.innerHTML = `<div style='font-size:1.15em;font-weight:bold;margin-bottom:12px;'>Selecciona recetas de equipo Normal</div>${tabla}`;
  inner.appendChild(resumenDiv);
  inner.appendChild(cerrar);
  modal.appendChild(inner);
  document.body.appendChild(modal);
  // Eventos + y -
  setTimeout(() => {
    document.querySelectorAll('.btn-mas').forEach(btn => {
      btn.onclick = function() {
        const idx = this.getAttribute('data-idx');
        recetasTiempoSeleccion[idx] = 1;
        actualizarTablaModalRecetas();
      };
    });
    document.querySelectorAll('.btn-menos').forEach(btn => {
      btn.onclick = function() {
        const idx = this.getAttribute('data-idx');
        recetasTiempoSeleccion[idx] = 0;
        actualizarTablaModalRecetas();
      };
    });
  }, 10);
  actualizarResumenModalTiempo();
}

function actualizarTablaModalRecetas() {
  // Re-renderizar solo el tbody de la tabla
  const tbody = document.querySelector('#tabla-modal-recetas-tiempo tbody');
  if (!tbody) return;
  const recetasNormales = recetas.map((r, idx) => ({...r, idx})).filter(r => r.clase === 'Normal');
  let html = '';
  recetasNormales.forEach(r => {
    const materialesStr = Object.entries(r.materiales)
      .filter(([color, cantidad]) => cantidad > 0)
      .map(([color, cantidad]) => `${cantidad} ${color}${cantidad > 1 ? 's' : ''}`)
      .join(', ');
    const cantidad = recetasTiempoSeleccion[r.idx] || 0;
    const desvanecido = cantidad > 0;
    html += `<tr data-idx='${r.idx}' style='${desvanecido ? "color:rgba(80,80,80,0.66);" : ""}'>`;
    html += `<td>${r.nivel}</td>`;
    html += `<td>${r.color.charAt(0).toUpperCase() + r.color.slice(1)}</td>`;
    html += `<td>${materialesStr}</td>`;
    html += `<td>${parseFloat(r.porcentaje).toFixed(2)}%</td>`;
    html += `<td><button class='btn-mas' data-idx='${r.idx}' style='font-size:1.5em;padding:8px 18px;margin:0 10px;background:#43a047;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:opacity 0.2s;${desvanecido ? "opacity:0.3;pointer-events:none;" : ""}'>+</button></td>`;
    html += `<td><button class='btn-menos' data-idx='${r.idx}' style='font-size:1.5em;padding:8px 18px;margin:0 10px;background:#e53935;color:#fff;border:none;border-radius:8px;cursor:pointer;'>-</button></td>`;
    html += `<td style='font-weight:bold;font-size:1.1em;'>${cantidad > 0 ? cantidad : ''}</td>`;
    html += `</tr>`;
  });
  tbody.innerHTML = html;
  // Reasignar eventos
  document.querySelectorAll('.btn-mas').forEach(btn => {
    btn.onclick = function() {
      const idx = this.getAttribute('data-idx');
      recetasTiempoSeleccion[idx] = 1;
      actualizarTablaModalRecetas();
    };
  });
  document.querySelectorAll('.btn-menos').forEach(btn => {
    btn.onclick = function() {
      const idx = this.getAttribute('data-idx');
      recetasTiempoSeleccion[idx] = 0;
      actualizarTablaModalRecetas();
    };
  });
  actualizarResumenModalTiempo();
}

function calcularTiempoReceta(receta) {
  let total = 0;
  for (const color in TIEMPOS_MATERIAL) {
    total += (receta.materiales[color] || 0) * TIEMPOS_MATERIAL[color];
  }
  return total;
}

function actualizarResumenModalTiempo() {
  // Calcular el total de horas y materiales
  let totalHoras = 0;
  let totalMateriales = { dorado:0, morado:0, azul:0, verde:0, blanco:0 };
  Object.entries(recetasTiempoSeleccion).forEach(([idx, cantidad]) => {
    cantidad = parseInt(cantidad);
    if (!cantidad || cantidad <= 0) return;
    const r = recetas[idx];
    if (!r) return;
    totalHoras += calcularTiempoReceta(r) * cantidad;
    for (const color in totalMateriales) {
      totalMateriales[color] += (r.materiales[color] || 0) * cantidad;
    }
  });
  // Conversión a meses, semanas, días, horas
  const horasFormateadas = totalHoras.toLocaleString('es-MX');
  let horasRestantes = totalHoras;
  const meses = Math.floor(horasRestantes / (30*24));
  horasRestantes = horasRestantes % (30*24);
  const semanas = Math.floor(horasRestantes / (7*24));
  horasRestantes = horasRestantes % (7*24);
  const dias = Math.floor(horasRestantes / 24);
  horasRestantes = horasRestantes % 24;
  let partes = [];
  if (meses > 0) partes.push(`🗓️ ${meses} mes${meses > 1 ? 'es' : ''}`);
  if (semanas > 0) partes.push(`📆 ${semanas} semana${semanas > 1 ? 's' : ''}`);
  if (dias > 0) partes.push(`📅 ${dias} día${dias > 1 ? 's' : ''}`);
  if (horasRestantes > 0 || partes.length === 0) partes.push(`🕒 ${horasRestantes} hora${horasRestantes !== 1 ? 's' : ''}`);
  let conversionStr = partes.join(', ');
  let html = `<div style='margin-bottom:8px;'><strong>Tiempo total:</strong> <span style='color:#1e3a8a;font-size:1.1em;'>🕒 ${horasFormateadas} horas</span></div>`;
  html += `<div style='color:#555;margin-bottom:8px;font-size:1.08em;'>= ${conversionStr}</div>`;
  html += `<div style='margin-bottom:4px;'><strong>Materiales totales:</strong></div>`;
  html += `<div style='display:flex;gap:12px;flex-wrap:wrap;'>`;
  for (const color of ['dorado','morado','azul','verde','blanco']) {
    html += `<span style='background:#eee;padding:4px 10px;border-radius:8px;font-weight:bold;color:#333;'>${color.charAt(0).toUpperCase()+color.slice(1)}: ${totalMateriales[color]}</span>`;
  }
  html += `</div>`;
  document.getElementById('modal-resumen-tiempo-recetas').innerHTML = html;
}

// Lógica de restricciones automáticas
const claseSelect = document.getElementById('clase');
const nivelSelect = document.getElementById('nivel');
const baseClaseSelect = document.getElementById('base-clase');
const baseNivelSelect = document.getElementById('base-nivel');

function aplicarRestricciones() {
    const clase = claseSelect.value;
    const nivelEquipo = parseInt(nivelSelect.value);
    // Reset: habilitar todo
    nivelSelect.disabled = false;
    baseClaseSelect.disabled = false;
    baseNivelSelect.disabled = false;
    // Habilitar todos los niveles de la base
    Array.from(baseNivelSelect.options).forEach(opt => { opt.disabled = false; });

    if (clase === 'Campeón') {
        nivelSelect.value = '4';
        nivelSelect.disabled = true;
        baseNivelSelect.value = '4';
        baseNivelSelect.disabled = true;
        baseClaseSelect.value = 'Normal';
        baseClaseSelect.disabled = true;
    } else if (clase === 'Planewalker' || clase === 'Lord') {
        nivelSelect.value = '5';
        nivelSelect.disabled = true;
        baseNivelSelect.value = '5';
        baseNivelSelect.disabled = true;
        baseClaseSelect.value = 'Normal';
        baseClaseSelect.disabled = true;
    } else if (clase === 'Noble Lord') {
        nivelSelect.value = '5';
        nivelSelect.disabled = true;
        baseNivelSelect.value = '5';
        baseNivelSelect.disabled = true;
        baseClaseSelect.value = 'Lord';
        baseClaseSelect.disabled = true;
    } else if (clase === 'Normal') {
        baseClaseSelect.value = 'Normal';
        baseClaseSelect.disabled = true;
        // Solo permitir niveles de base <= nivel del equipo
        Array.from(baseNivelSelect.options).forEach(opt => {
            if (opt.value && parseInt(opt.value) > nivelEquipo) {
                opt.disabled = true;
            }
        });
        // Si el nivel actual de la base es mayor, lo ajusta
        if (baseNivelSelect.value && parseInt(baseNivelSelect.value) > nivelEquipo) {
            baseNivelSelect.value = nivelEquipo;
        }
    } else {
        // Normal: todo editable
        nivelSelect.disabled = false;
        baseClaseSelect.disabled = false;
        baseNivelSelect.disabled = false;
    }
}
claseSelect.addEventListener('change', aplicarRestricciones);
nivelSelect.addEventListener('change', aplicarRestricciones);
document.addEventListener('DOMContentLoaded', aplicarRestricciones);

document.getElementById('confirm-borrar-aceptar').onclick = function() {
    if (borrarIndex !== null && borrarIndex >= 0) {
        recetas.splice(borrarIndex, 1);
        renderTabla();
        resetFormularioUI();
    }
    borrarIndex = null;
    document.getElementById('modal-confirm-borrar').style.display = 'none';
};
document.getElementById('confirm-borrar-cancelar').onclick = function() {
    borrarIndex = null;
    document.getElementById('modal-confirm-borrar').style.display = 'none';
};
</script>
</body>
</html> 