<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Generador de Recetas Universal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            padding: 40px;
        }
        .container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            width: 90vw;
            max-width: 1200px;
            margin: auto;
            padding: 32px 18px 32px 18px;
        }
        h2 {
            color: #333;
            text-align: center;
        }
        fieldset {
            border: 1.5px solid #bbb;
            border-radius: 8px;
            margin-bottom: 18px;
            padding: 18px 12px 12px 12px;
            position: relative;
        }
        legend {
            font-size: 1.05rem;
            font-weight: bold;
            color: #555;
            position: absolute;
            top: -1.2em;
            right: 16px;
            background: #fff;
            padding: 0 8px;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 4px;
        }
        select, input[type="number"] {
            padding: 6px 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #bbb;
            font-size: 1rem;
        }
        .materiales-select {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .agregar-btn {
            display: block;
            width: 100%;
            margin: 18px 0 24px 0;
            padding: 10px 0;
            font-size: 1.1rem;
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .agregar-btn:hover {
            background: #1769aa;
        }
        .filtros {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .filtros label {
            margin: 0 2px 0 0;
            font-size: 0.98rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: center;
        }
        th {
            background: #eee;
        }
        .inline-selects {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
<div class="container">
    <div style="display:flex;gap:12px;justify-content:center;margin-bottom:18px;">
        <button id="importar-recetas" style="padding:10px 24px;font-size:1rem;background:#1976d2;color:#fff;border:none;border-radius:6px;cursor:pointer;">Importar recetas</button>
        <input type="file" id="file-import" accept=".json" style="display:none;">
    </div>
    <h2>Generador de Recetas Universal</h2>
    <form id="receta-form" autocomplete="off">
        <fieldset>
            <legend>Equipo final</legend>
            <div class="inline-selects">
                <label for="clase">Clase:</label>
                <select id="clase" required>
                    <option value="Normal">Normal</option>
                    <option value="Campeón">Campeón</option>
                    <option value="Planewalker">Planewalker</option>
                    <option value="Lord">Lord</option>
                    <option value="Noble Lord">Noble Lord</option>
                </select>
                <label for="nivel">Nivel:</label>
                <select id="nivel" required>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <label for="color">Color:</label>
                <select id="color" required>
                    <option value="blanco">Blanco</option>
                    <option value="verde">Verde</option>
                    <option value="azul">Azul</option>
                    <option value="morado">Morado</option>
                    <option value="dorado">Dorado</option>
                </select>
            </div>
        </fieldset>
        <fieldset>
            <legend>Materiales</legend>
            <div class="materiales-select inline-selects">
                <select class="color-material">
                    <option value="0">Dorado: 0</option>
                    <option value="1">Dorado: 1</option>
                    <option value="2">Dorado: 2</option>
                    <option value="3">Dorado: 3</option>
                    <option value="4">Dorado: 4</option>
                </select>
                <select class="color-material">
                    <option value="0">Morado: 0</option>
                    <option value="1">Morado: 1</option>
                    <option value="2">Morado: 2</option>
                    <option value="3">Morado: 3</option>
                    <option value="4">Morado: 4</option>
                </select>
                <select class="color-material">
                    <option value="0">Azul: 0</option>
                    <option value="1">Azul: 1</option>
                    <option value="2">Azul: 2</option>
                    <option value="3">Azul: 3</option>
                    <option value="4">Azul: 4</option>
                </select>
                <select class="color-material">
                    <option value="0">Verde: 0</option>
                    <option value="1">Verde: 1</option>
                    <option value="2">Verde: 2</option>
                    <option value="3">Verde: 3</option>
                    <option value="4">Verde: 4</option>
                </select>
                <select class="color-material">
                    <option value="0">Blanco: 0</option>
                    <option value="1">Blanco: 1</option>
                    <option value="2">Blanco: 2</option>
                    <option value="3">Blanco: 3</option>
                    <option value="4">Blanco: 4</option>
                </select>
            </div>
        </fieldset>
        <fieldset>
            <legend>Base</legend>
            <div class="inline-selects">
                <label for="base-clase">Clase:</label>
                <select id="base-clase">
                    <option value="">-</option>
                    <option value="Normal">Normal</option>
                    <option value="Campeón">Campeón</option>
                    <option value="Planewalker">Planewalker</option>
                    <option value="Lord">Lord</option>
                    <option value="Noble Lord">Noble Lord</option>
                </select>
                <label for="base-nivel">Nivel:</label>
                <select id="base-nivel">
                    <option value="">-</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <label for="base-color">Color:</label>
                <select id="base-color">
                    <option value="">-</option>
                    <option value="blanco">Blanco</option>
                    <option value="verde">Verde</option>
                    <option value="azul">Azul</option>
                    <option value="morado">Morado</option>
                    <option value="dorado">Dorado</option>
                </select>
            </div>
        </fieldset>
        <fieldset>
            <legend>Éxito</legend>
            <div class="inline-selects">
                <label for="porcentaje">Porcentaje:</label>
                <input id="porcentaje" type="number" min="0" max="100" step="0.01" placeholder="0.00" required style="width:100px;">
            </div>
        </fieldset>
        <button type="submit" class="agregar-btn" form="receta-form">Agregar receta</button>
    </form>

    <div class="filtros">
        <label for="filtro-clase">Filtrar clase:</label>
        <select id="filtro-clase">
            <option value="">Todas</option>
            <option value="Normal">Normal</option>
            <option value="Campeón">Campeón</option>
            <option value="Planewalker">Planewalker</option>
            <option value="Lord">Lord</option>
            <option value="Noble Lord">Noble Lord</option>
        </select>
        <label for="filtro-nivel">Nivel:</label>
        <select id="filtro-nivel">
            <option value="">Todos</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
    </div>
    <table id="tabla-recetas" style="display:none;">
        <thead>
            <tr>
                <th rowspan="2">#</th>
                <th colspan="8">Equipo</th>
                <th colspan="3">Base</th>
                <th rowspan="2">Éxito</th>
                <th rowspan="2">Acciones</th>
            </tr>
            <tr>
                <th>Clase</th>
                <th>Nivel</th>
                <th>Color</th>
                <th>Dorado</th>
                <th>Morado</th>
                <th>Azul</th>
                <th>Verde</th>
                <th>Blanco</th>
                <th>Clase</th>
                <th>Nivel</th>
                <th>Color</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div style="display:flex;gap:12px;justify-content:center;margin:18px 0 0 0;">
        <button id="guardar-recetas" style="display:none;padding:10px 24px;font-size:1rem;background:#43a047;color:#fff;border:none;border-radius:6px;cursor:pointer;">Guardar recetas</button>
    </div>
</div>
<script>
const form = document.getElementById('receta-form');
const tabla = document.getElementById('tabla-recetas');
const tbody = tabla.querySelector('tbody');
let recetas = [];

form.onsubmit = function(e) {
    e.preventDefault();
    const clase = document.getElementById('clase').value;
    const nivel = document.getElementById('nivel').value;
    const color = document.getElementById('color').value;
    const porcentaje = parseFloat(document.getElementById('porcentaje').value).toFixed(2);
    // Obtener cantidades de materiales
    const materiales = {
        dorado: parseInt(document.querySelectorAll('.color-material')[0].value),
        morado: parseInt(document.querySelectorAll('.color-material')[1].value),
        azul: parseInt(document.querySelectorAll('.color-material')[2].value),
        verde: parseInt(document.querySelectorAll('.color-material')[3].value),
        blanco: parseInt(document.querySelectorAll('.color-material')[4].value)
    };
    // Verificar que al menos un material tenga cantidad > 0
    const totalMateriales = Object.values(materiales).reduce((sum, val) => sum + val, 0);
    if (totalMateriales === 0) {
        alert('Debes seleccionar al menos un material.');
        return;
    }
    if (totalMateriales > 4) {
        alert('No puedes seleccionar más de 4 materiales en total.');
        return;
    }
    // Obtener datos de la base
    const baseClase = document.getElementById('base-clase').value;
    const baseNivel = document.getElementById('base-nivel').value;
    const baseColor = document.getElementById('base-color').value;
    const base = baseClase ? {
        clase: baseClase,
        nivel: baseNivel,
        color: baseColor
    } : null;
    recetas.push({ clase, nivel, color, porcentaje, materiales, base });
    renderTabla();
    form.reset();
    // Limpiar también el formulario de base
    document.getElementById('base-clase').value = '';
    document.getElementById('base-nivel').value = '';
    document.getElementById('base-color').value = '';
};

document.getElementById('filtro-clase').onchange = renderTabla;
document.getElementById('filtro-nivel').onchange = renderTabla;

document.getElementById('guardar-recetas').onclick = function() {
    if (recetas.length === 0) return;
    const dataStr = JSON.stringify(recetas, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'recetas.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

function renderTabla() {
    const filtroClase = document.getElementById('filtro-clase').value;
    const filtroNivel = document.getElementById('filtro-nivel').value;
    let recetasFiltradas = recetas;
    if (filtroClase) {
        recetasFiltradas = recetasFiltradas.filter(r => r.clase === filtroClase);
    }
    if (filtroNivel) {
        recetasFiltradas = recetasFiltradas.filter(r => r.nivel === filtroNivel);
    }
    if (recetasFiltradas.length === 0) {
        tabla.style.display = 'none';
        document.getElementById('guardar-recetas').style.display = 'none';
        return;
    }
    tabla.style.display = '';
    document.getElementById('guardar-recetas').style.display = 'block';
    tbody.innerHTML = '';
    recetasFiltradas.forEach((receta, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${receta.clase}</td>
            <td>${receta.nivel}</td>
            <td>${receta.color}</td>
            <td>${receta.materiales.dorado}</td>
            <td>${receta.materiales.morado}</td>
            <td>${receta.materiales.azul}</td>
            <td>${receta.materiales.verde}</td>
            <td>${receta.materiales.blanco}</td>
            <td>${receta.base ? receta.base.clase : ''}</td>
            <td>${receta.base ? receta.base.nivel : ''}</td>
            <td>${receta.base ? receta.base.color : ''}</td>
            <td>${receta.porcentaje}%</td>
            <td>
                <button class="editar-btn" title="Editar" style="background:none;border:none;cursor:pointer;font-size:1.2em;">✏️</button>
                <button class="borrar-btn" title="Borrar" style="background:none;border:none;cursor:pointer;font-size:1.2em;">🗑️</button>
            </td>
        `;
        // Acciones borrar y editar
        tr.querySelector('.borrar-btn').onclick = () => {
            const realIdx = recetas.indexOf(recetasFiltradas[idx]);
            if (realIdx !== -1) {
                recetas.splice(realIdx, 1);
                renderTabla();
            }
        };
        tr.querySelector('.editar-btn').onclick = () => {
            // Cargar los datos de la receta en el formulario para editar
            const r = recetasFiltradas[idx];
            document.getElementById('clase').value = r.clase;
            document.getElementById('color').value = r.color;
            document.getElementById('porcentaje').value = r.porcentaje;
            document.querySelectorAll('.color-material')[0].value = r.materiales.dorado;
            document.querySelectorAll('.color-material')[1].value = r.materiales.morado;
            document.querySelectorAll('.color-material')[2].value = r.materiales.azul;
            document.querySelectorAll('.color-material')[3].value = r.materiales.verde;
            document.querySelectorAll('.color-material')[4].value = r.materiales.blanco;
            if (r.base) {
                document.getElementById('base-clase').value = r.base.clase;
                document.getElementById('base-nivel').value = r.base.nivel;
                document.getElementById('base-color').value = r.base.color;
            } else {
                document.getElementById('base-clase').value = '';
                document.getElementById('base-nivel').value = '';
                document.getElementById('base-color').value = '';
            }
            document.getElementById('nivel').value = r.nivel;
            aplicarRestricciones();
            // Eliminar la receta editada para que al guardar se reemplace
            const realIdx = recetas.indexOf(recetasFiltradas[idx]);
            if (realIdx !== -1) {
                recetas.splice(realIdx, 1);
                renderTabla();
            }
        };
        tbody.appendChild(tr);
    });
    // Mostrar/ocultar botones de guardar/importar
    document.getElementById('guardar-recetas').style.display = recetas.length ? 'block' : 'none';
    document.getElementById('importar-recetas').style.display = 'block';
}

// Lógica de restricciones automáticas
const claseSelect = document.getElementById('clase');
const nivelSelect = document.getElementById('nivel');
const baseClaseSelect = document.getElementById('base-clase');
const baseNivelSelect = document.getElementById('base-nivel');

function aplicarRestricciones() {
    const clase = claseSelect.value;
    const nivelEquipo = parseInt(nivelSelect.value);
    // Reset: habilitar todo
    nivelSelect.disabled = false;
    baseClaseSelect.disabled = false;
    baseNivelSelect.disabled = false;
    // Habilitar todos los niveles de la base
    Array.from(baseNivelSelect.options).forEach(opt => { opt.disabled = false; });

    if (clase === 'Campeón') {
        nivelSelect.value = '4';
        nivelSelect.disabled = true;
        baseNivelSelect.value = '4';
        baseNivelSelect.disabled = true;
        baseClaseSelect.value = 'Normal';
        baseClaseSelect.disabled = true;
    } else if (clase === 'Planewalker' || clase === 'Lord') {
        nivelSelect.value = '5';
        nivelSelect.disabled = true;
        baseNivelSelect.value = '5';
        baseNivelSelect.disabled = true;
        baseClaseSelect.value = 'Normal';
        baseClaseSelect.disabled = true;
    } else if (clase === 'Noble Lord') {
        nivelSelect.value = '5';
        nivelSelect.disabled = true;
        baseNivelSelect.value = '5';
        baseNivelSelect.disabled = true;
        baseClaseSelect.value = 'Lord';
        baseClaseSelect.disabled = true;
    } else if (clase === 'Normal') {
        baseClaseSelect.value = 'Normal';
        baseClaseSelect.disabled = true;
        // Solo permitir niveles de base <= nivel del equipo
        Array.from(baseNivelSelect.options).forEach(opt => {
            if (opt.value && parseInt(opt.value) > nivelEquipo) {
                opt.disabled = true;
            }
        });
        // Si el nivel actual de la base es mayor, lo ajusta
        if (baseNivelSelect.value && parseInt(baseNivelSelect.value) > nivelEquipo) {
            baseNivelSelect.value = nivelEquipo;
        }
    } else {
        // Normal: todo editable
        nivelSelect.disabled = false;
        baseClaseSelect.disabled = false;
        baseNivelSelect.disabled = false;
    }
}
claseSelect.addEventListener('change', aplicarRestricciones);
nivelSelect.addEventListener('change', aplicarRestricciones);
document.addEventListener('DOMContentLoaded', aplicarRestricciones);

document.getElementById('importar-recetas').onclick = function() {
    document.getElementById('file-import').click();
};
document.getElementById('file-import').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            const data = JSON.parse(evt.target.result);
            if (!Array.isArray(data)) throw new Error('El archivo no contiene un array de recetas.');
            let nuevos = 0;
            data.forEach(recetaNueva => {
                // Deduplicación: compara todos los campos relevantes
                const existe = recetas.some(r =>
                    JSON.stringify(r) === JSON.stringify(recetaNueva)
                );
                if (!existe) {
                    recetas.push(recetaNueva);
                    nuevos++;
                }
            });
            renderTabla();
            alert(`Se importaron ${nuevos} recetas nuevas.`);
        } catch (err) {
            alert('Error al importar: ' + err.message);
        }
    };
    reader.readAsText(file);
};
</script>
</body>
</html> 