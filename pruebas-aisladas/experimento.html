<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Generador de Recetas Universal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            padding: 40px;
        }
        .container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            width: 90vw;
            max-width: 1200px;
            margin: auto;
            padding: 32px 18px 32px 18px;
        }
        h2 {
            color: #333;
            text-align: center;
        }
        fieldset {
            border: 1.5px solid #bbb;
            border-radius: 8px;
            margin-bottom: 18px;
            padding: 18px 12px 12px 12px;
            position: relative;
        }
        legend {
            font-size: 1.05rem;
            font-weight: bold;
            color: #555;
            position: absolute;
            top: -1.2em;
            right: 16px;
            background: #fff;
            padding: 0 8px;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 4px;
        }
        select, input[type="number"] {
            padding: 6px 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #bbb;
            font-size: 1rem;
        }
        .materiales-select {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .agregar-btn {
            display: block;
            width: 100%;
            margin: 18px 0 24px 0;
            padding: 10px 0;
            font-size: 1.1rem;
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .agregar-btn:hover {
            background: #1769aa;
        }
        .filtros {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .filtros label {
            margin: 0 2px 0 0;
            font-size: 0.98rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: center;
        }
        th {
            background: #eee;
        }
        .inline-selects {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .secciones-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 16px;
            margin-bottom: 18px;
        }
        .secciones-grid fieldset {
            margin-bottom: 0;
        }
        @media (max-width: 700px) {
            .secciones-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div style="display:flex;gap:12px;justify-content:center;margin-bottom:18px;">
        <button id="importar-recetas" style="padding:10px 24px;font-size:1rem;background:#1976d2;color:#fff;border:none;border-radius:6px;cursor:pointer;">Importar recetas</button>
        <input type="file" id="file-import" accept=".json" style="display:none;">
    </div>
    <h2>Generador de Recetas Universal</h2>
    <form id="receta-form" autocomplete="off">
        <div class="secciones-grid">
            <fieldset>
                <legend>Equipo final</legend>
                <div class="inline-selects">
                    <label for="clase">Clase:</label>
                    <select id="clase" required>
                        <option value="Normal">Normal</option>
                        <option value="Campeón">Campeón</option>
                        <option value="Planewalker">Planewalker</option>
                        <option value="Lord">Lord</option>
                        <option value="Noble Lord">Noble Lord</option>
                    </select>
                    <label for="nivel">Nivel:</label>
                    <select id="nivel" required>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                    <label for="color">Color:</label>
                    <select id="color" required>
                        <option value="blanco">Blanco</option>
                        <option value="verde">Verde</option>
                        <option value="azul">Azul</option>
                        <option value="morado">Morado</option>
                        <option value="dorado">Dorado</option>
                    </select>
                </div>
            </fieldset>
            <fieldset>
                <legend>Materiales</legend>
                <div class="materiales-select inline-selects">
                    <select class="color-material">
                        <option value="0">Dorado: 0</option>
                        <option value="1">Dorado: 1</option>
                        <option value="2">Dorado: 2</option>
                        <option value="3">Dorado: 3</option>
                        <option value="4">Dorado: 4</option>
                    </select>
                    <select class="color-material">
                        <option value="0">Morado: 0</option>
                        <option value="1">Morado: 1</option>
                        <option value="2">Morado: 2</option>
                        <option value="3">Morado: 3</option>
                        <option value="4">Morado: 4</option>
                    </select>
                    <select class="color-material">
                        <option value="0">Azul: 0</option>
                        <option value="1">Azul: 1</option>
                        <option value="2">Azul: 2</option>
                        <option value="3">Azul: 3</option>
                        <option value="4">Azul: 4</option>
                    </select>
                    <select class="color-material">
                        <option value="0">Verde: 0</option>
                        <option value="1">Verde: 1</option>
                        <option value="2">Verde: 2</option>
                        <option value="3">Verde: 3</option>
                        <option value="4">Verde: 4</option>
                    </select>
                    <select class="color-material">
                        <option value="0">Blanco: 0</option>
                        <option value="1">Blanco: 1</option>
                        <option value="2">Blanco: 2</option>
                        <option value="3">Blanco: 3</option>
                        <option value="4">Blanco: 4</option>
                    </select>
                </div>
            </fieldset>
            <fieldset>
                <legend>Base</legend>
                <div class="inline-selects">
                    <label for="base-clase">Clase:</label>
                    <select id="base-clase">
                        <option value="">-</option>
                        <option value="Normal">Normal</option>
                        <option value="Campeón">Campeón</option>
                        <option value="Planewalker">Planewalker</option>
                        <option value="Lord">Lord</option>
                        <option value="Noble Lord">Noble Lord</option>
                    </select>
                    <label for="base-nivel">Nivel:</label>
                    <select id="base-nivel">
                        <option value="">-</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                    <label for="base-color">Color:</label>
                    <select id="base-color">
                        <option value="">-</option>
                        <option value="blanco">Blanco</option>
                        <option value="verde">Verde</option>
                        <option value="azul">Azul</option>
                        <option value="morado">Morado</option>
                        <option value="dorado">Dorado</option>
                    </select>
                </div>
            </fieldset>
            <fieldset>
                <legend>Éxito</legend>
                <div class="inline-selects">
                    <label for="porcentaje">Porcentaje:</label>
                    <input id="porcentaje" type="number" min="0" max="100" step="0.01" placeholder="0.00" required style="width:100px;">
                </div>
            </fieldset>
        </div>
        <button type="submit" class="agregar-btn" form="receta-form">Agregar receta</button>
    </form>

    <div class="filtros">
        <label for="filtro-clase">Filtrar clase:</label>
        <select id="filtro-clase">
            <option value="">Todas</option>
            <option value="Normal">Normal</option>
            <option value="Campeón">Campeón</option>
            <option value="Planewalker">Planewalker</option>
            <option value="Lord">Lord</option>
            <option value="Noble Lord">Noble Lord</option>
        </select>
        <label for="filtro-nivel">Nivel:</label>
        <select id="filtro-nivel">
            <option value="">Todos</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
    </div>
    <table id="tabla-recetas" style="display:none;">
        <thead>
            <tr>
                <th rowspan="2">#</th>
                <th colspan="8">Equipo</th>
                <th colspan="3">Base</th>
                <th rowspan="2">Éxito</th>
                <th rowspan="2">Acciones</th>
            </tr>
            <tr>
                <th>Clase</th>
                <th>Nivel</th>
                <th>Color</th>
                <th>Dorado</th>
                <th>Morado</th>
                <th>Azul</th>
                <th>Verde</th>
                <th>Blanco</th>
                <th>Clase</th>
                <th>Nivel</th>
                <th>Color</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div style="display:flex;gap:12px;justify-content:center;margin:18px 0 0 0;">
        <button id="guardar-recetas" style="display:none;padding:10px 24px;font-size:1rem;background:#43a047;color:#fff;border:none;border-radius:6px;cursor:pointer;">Guardar recetas</button>
    </div>
</div>
<div id="modal-confirm-borrar" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:28px 24px 18px 24px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.18);max-width:320px;text-align:center;">
    <div style="font-size:1.15rem;margin-bottom:18px;">¿Seguro que deseas borrar esta receta?</div>
    <button id="confirm-borrar-aceptar" style="background:#43a047;color:#fff;font-size:1.2rem;padding:8px 18px;margin:0 10px 0 0;border:none;border-radius:6px;cursor:pointer;">Aceptar ✅</button>
    <button id="confirm-borrar-cancelar" style="background:#e53935;color:#fff;font-size:1.2rem;padding:8px 18px;border:none;border-radius:6px;cursor:pointer;">NO ❌</button>
  </div>
</div>
<div id="analizador-tiempo-recetas" style="margin:32px auto 0 auto;max-width:600px;padding:18px 16px 16px 16px;background:#f8f9fa;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:none;">
  <h3 style="margin-top:0;margin-bottom:12px;font-size:1.15rem;color:#1e3a8a;text-align:center;">⏳ Analizador de Tiempo (solo equipo Normal)</h3>
  <div id="lista-tiempo-recetas"></div>
  <div style="margin:10px 0 0 0;text-align:center;">
    <button id="agregar-receta-tiempo" style="background:#43a047;color:#fff;font-size:1.1rem;padding:6px 18px;border:none;border-radius:6px;cursor:pointer;">+ Agregar receta</button>
    <button id="limpiar-tiempo-recetas" style="background:#e53935;color:#fff;font-size:1.1rem;padding:6px 18px;border:none;border-radius:6px;cursor:pointer;margin-left:8px;">Limpiar</button>
  </div>
  <div id="resumen-tiempo-recetas" style="margin-top:18px;"></div>
</div>
<script>
const form = document.getElementById('receta-form');
const tabla = document.getElementById('tabla-recetas');
const tbody = tabla.querySelector('tbody');
let recetas = [];
let editIndex = null; // Índice de la receta que se está editando
let borrarIndex = null;
const agregarBtn = document.querySelector('.agregar-btn');

function resetFormularioUI() {
    form.reset();
    document.getElementById('base-clase').value = '';
    document.getElementById('base-nivel').value = '';
    document.getElementById('base-color').value = '';
    agregarBtn.textContent = 'Agregar receta';
    agregarBtn.style.background = '#2196F3';
    editIndex = null;
    aplicarRestricciones();
}

form.onsubmit = function(e) {
    e.preventDefault();
    const clase = document.getElementById('clase').value;
    const nivel = document.getElementById('nivel').value;
    const color = document.getElementById('color').value;
    const porcentaje = parseFloat(document.getElementById('porcentaje').value).toFixed(2);
    // Obtener cantidades de materiales
    const materiales = {
        dorado: parseInt(document.querySelectorAll('.color-material')[0].value),
        morado: parseInt(document.querySelectorAll('.color-material')[1].value),
        azul: parseInt(document.querySelectorAll('.color-material')[2].value),
        verde: parseInt(document.querySelectorAll('.color-material')[3].value),
        blanco: parseInt(document.querySelectorAll('.color-material')[4].value)
    };
    // Verificar que al menos un material tenga cantidad > 0
    const totalMateriales = Object.values(materiales).reduce((sum, val) => sum + val, 0);
    if (totalMateriales === 0) {
        alert('Debes seleccionar al menos un material.');
        return;
    }
    if (totalMateriales > 4) {
        alert('No puedes seleccionar más de 4 materiales en total.');
        return;
    }
    // Obtener datos de la base
    const baseClase = document.getElementById('base-clase').value;
    const baseNivel = document.getElementById('base-nivel').value;
    const baseColor = document.getElementById('base-color').value;
    const base = baseClase ? {
        clase: baseClase,
        nivel: baseNivel,
        color: baseColor
    } : null;
    const nuevaReceta = { clase, nivel, color, porcentaje, materiales, base };
    if (editIndex !== null) {
        recetas[editIndex] = nuevaReceta;
    } else {
        recetas.push(nuevaReceta);
    }
    renderTabla();
    resetFormularioUI();
};

document.getElementById('filtro-clase').onchange = renderTabla;
document.getElementById('filtro-nivel').onchange = renderTabla;

document.getElementById('guardar-recetas').onclick = function() {
    if (recetas.length === 0) return;
    const dataStr = JSON.stringify(recetas, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'recetas.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

function renderTabla() {
    const filtroClase = document.getElementById('filtro-clase').value;
    const filtroNivel = document.getElementById('filtro-nivel').value;
    let recetasFiltradas = recetas;
    if (filtroClase) {
        recetasFiltradas = recetasFiltradas.filter(r => r.clase === filtroClase);
    }
    if (filtroNivel) {
        recetasFiltradas = recetasFiltradas.filter(r => r.nivel === filtroNivel);
    }
    // Ordenar por clase, nivel, color (jerarquía), número de materiales (jerarquía)
    const colorOrden = { dorado: 5, morado: 4, azul: 3, verde: 2, blanco: 1 };
    const claseOrden = { 'Normal': 1, 'Campeón': 2, 'Planewalker': 3, 'Lord': 4, 'Noble Lord': 5 };
    recetasFiltradas = recetasFiltradas.slice().sort((a, b) => {
        // 1. Clase (jerarquía definida)
        const claseA = claseOrden[a.clase] || 99;
        const claseB = claseOrden[b.clase] || 99;
        if (claseA !== claseB) return claseA - claseB;
        // 2. Nivel (numérico ascendente)
        const nivelA = parseInt(a.nivel);
        const nivelB = parseInt(b.nivel);
        if (nivelA !== nivelB) return nivelA - nivelB;
        // 3. Color (jerarquía)
        const colorA = colorOrden[a.color] || 0;
        const colorB = colorOrden[b.color] || 0;
        if (colorA !== colorB) return colorB - colorA;
        // 4. Número de materiales por jerarquía (ponderado)
        const sumaA = Object.entries(a.materiales).reduce((acc, [col, val]) => acc + (colorOrden[col] || 0) * (val || 0), 0);
        const sumaB = Object.entries(b.materiales).reduce((acc, [col, val]) => acc + (colorOrden[col] || 0) * (val || 0), 0);
        return sumaB - sumaA;
    });
    if (recetasFiltradas.length === 0) {
        tabla.style.display = 'none';
        document.getElementById('guardar-recetas').style.display = 'none';
        return;
    }
    tabla.style.display = '';
    document.getElementById('guardar-recetas').style.display = 'block';
    tbody.innerHTML = '';
    recetasFiltradas.forEach((receta, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${receta.clase}</td>
            <td>${receta.nivel}</td>
            <td>${receta.color}</td>
            <td>${receta.materiales.dorado}</td>
            <td>${receta.materiales.morado}</td>
            <td>${receta.materiales.azul}</td>
            <td>${receta.materiales.verde}</td>
            <td>${receta.materiales.blanco}</td>
            <td>${receta.base ? receta.base.clase : ''}</td>
            <td>${receta.base ? receta.base.nivel : ''}</td>
            <td>${receta.base ? receta.base.color : ''}</td>
            <td>${receta.porcentaje}%</td>
            <td>
                <button class="editar-btn" title="Editar" style="background:none;border:none;cursor:pointer;font-size:1.2em;">✏️</button>
                <button class="borrar-btn" title="Borrar" style="background:none;border:none;cursor:pointer;font-size:1.2em;">🗑️</button>
            </td>
        `;
        // Acciones borrar y editar
        tr.querySelector('.borrar-btn').onclick = () => {
            borrarIndex = recetas.indexOf(recetasFiltradas[idx]);
            document.getElementById('modal-confirm-borrar').style.display = 'flex';
        };
        tr.querySelector('.editar-btn').onclick = () => {
            // Cargar los datos de la receta en el formulario para editar
            const r = recetasFiltradas[idx];
            document.getElementById('clase').value = r.clase;
            document.getElementById('color').value = r.color;
            document.getElementById('porcentaje').value = r.porcentaje;
            document.querySelectorAll('.color-material')[0].value = r.materiales.dorado;
            document.querySelectorAll('.color-material')[1].value = r.materiales.morado;
            document.querySelectorAll('.color-material')[2].value = r.materiales.azul;
            document.querySelectorAll('.color-material')[3].value = r.materiales.verde;
            document.querySelectorAll('.color-material')[4].value = r.materiales.blanco;
            if (r.base) {
                document.getElementById('base-clase').value = r.base.clase;
                document.getElementById('base-nivel').value = r.base.nivel;
                document.getElementById('base-color').value = r.base.color;
            } else {
                document.getElementById('base-clase').value = '';
                document.getElementById('base-nivel').value = '';
                document.getElementById('base-color').value = '';
            }
            document.getElementById('nivel').value = r.nivel;
            aplicarRestricciones();
            // Guardar el índice real de la receta que se está editando
            editIndex = recetas.indexOf(recetasFiltradas[idx]);
            agregarBtn.textContent = 'Modificar receta';
            agregarBtn.style.background = '#ff9800';
        };
        tbody.appendChild(tr);
    });
    // Mostrar/ocultar botones de guardar/importar
    document.getElementById('guardar-recetas').style.display = recetas.length ? 'block' : 'none';
    document.getElementById('importar-recetas').style.display = 'block';
}

// Lógica de restricciones automáticas
const claseSelect = document.getElementById('clase');
const nivelSelect = document.getElementById('nivel');
const baseClaseSelect = document.getElementById('base-clase');
const baseNivelSelect = document.getElementById('base-nivel');

function aplicarRestricciones() {
    const clase = claseSelect.value;
    const nivelEquipo = parseInt(nivelSelect.value);
    // Reset: habilitar todo
    nivelSelect.disabled = false;
    baseClaseSelect.disabled = false;
    baseNivelSelect.disabled = false;
    // Habilitar todos los niveles de la base
    Array.from(baseNivelSelect.options).forEach(opt => { opt.disabled = false; });

    if (clase === 'Campeón') {
        nivelSelect.value = '4';
        nivelSelect.disabled = true;
        baseNivelSelect.value = '4';
        baseNivelSelect.disabled = true;
        baseClaseSelect.value = 'Normal';
        baseClaseSelect.disabled = true;
    } else if (clase === 'Planewalker' || clase === 'Lord') {
        nivelSelect.value = '5';
        nivelSelect.disabled = true;
        baseNivelSelect.value = '5';
        baseNivelSelect.disabled = true;
        baseClaseSelect.value = 'Normal';
        baseClaseSelect.disabled = true;
    } else if (clase === 'Noble Lord') {
        nivelSelect.value = '5';
        nivelSelect.disabled = true;
        baseNivelSelect.value = '5';
        baseNivelSelect.disabled = true;
        baseClaseSelect.value = 'Lord';
        baseClaseSelect.disabled = true;
    } else if (clase === 'Normal') {
        baseClaseSelect.value = 'Normal';
        baseClaseSelect.disabled = true;
        // Solo permitir niveles de base <= nivel del equipo
        Array.from(baseNivelSelect.options).forEach(opt => {
            if (opt.value && parseInt(opt.value) > nivelEquipo) {
                opt.disabled = true;
            }
        });
        // Si el nivel actual de la base es mayor, lo ajusta
        if (baseNivelSelect.value && parseInt(baseNivelSelect.value) > nivelEquipo) {
            baseNivelSelect.value = nivelEquipo;
        }
    } else {
        // Normal: todo editable
        nivelSelect.disabled = false;
        baseClaseSelect.disabled = false;
        baseNivelSelect.disabled = false;
    }
}
claseSelect.addEventListener('change', aplicarRestricciones);
nivelSelect.addEventListener('change', aplicarRestricciones);
document.addEventListener('DOMContentLoaded', aplicarRestricciones);

document.getElementById('importar-recetas').onclick = function() {
    document.getElementById('file-import').click();
};
document.getElementById('file-import').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            const data = JSON.parse(evt.target.result);
            if (!Array.isArray(data)) throw new Error('El archivo no contiene un array de recetas.');
            let nuevos = 0;
            data.forEach(recetaNueva => {
                // Deduplicación: compara todos los campos relevantes
                const existe = recetas.some(r =>
                    JSON.stringify(r) === JSON.stringify(recetaNueva)
                );
                if (!existe) {
                    recetas.push(recetaNueva);
                    nuevos++;
                }
            });
            renderTabla();
            resetFormularioUI();
            alert(`Se importaron ${nuevos} recetas nuevas.`);
        } catch (err) {
            alert('Error al importar: ' + err.message);
        }
    };
    reader.readAsText(file);
};

document.getElementById('confirm-borrar-aceptar').onclick = function() {
    if (borrarIndex !== null && borrarIndex >= 0) {
        recetas.splice(borrarIndex, 1);
        renderTabla();
        resetFormularioUI();
    }
    borrarIndex = null;
    document.getElementById('modal-confirm-borrar').style.display = 'none';
};
document.getElementById('confirm-borrar-cancelar').onclick = function() {
    borrarIndex = null;
    document.getElementById('modal-confirm-borrar').style.display = 'none';
};

const TIEMPOS_MATERIAL = { dorado: 512, morado: 128, azul: 32, verde: 8, blanco: 2 };
let recetasTiempo = [];

function mostrarAnalizadorTiempo() {
  const div = document.getElementById('analizador-tiempo-recetas');
  if (!div) return;
  // Solo mostrar si hay recetas de clase Normal
  const recetasNormales = recetas.filter(r => r.clase === 'Normal');
  if (recetasNormales.length === 0) {
    div.style.display = 'none';
    return;
  }
  div.style.display = 'block';
  renderListaTiempoRecetas();
}

function renderListaTiempoRecetas() {
  const listaDiv = document.getElementById('lista-tiempo-recetas');
  if (!listaDiv) return;
  if (recetasTiempo.length === 0) {
    listaDiv.innerHTML = '<div style="color:#888;text-align:center;">Agrega recetas para analizar su tiempo total.</div>';
    document.getElementById('resumen-tiempo-recetas').innerHTML = '';
    return;
  }
  let html = '<ul style="list-style:none;padding:0;margin:0;">';
  recetasTiempo.forEach((idx, i) => {
    const r = recetas[idx];
    if (!r) return;
    const tiempo = calcularTiempoReceta(r);
    // Construir string de materiales (solo los > 0)
    const materialesStr = Object.entries(r.materiales)
      .filter(([color, cantidad]) => cantidad > 0)
      .map(([color, cantidad]) => `${cantidad} ${color}${cantidad > 1 ? 's' : ''}`)
      .join(' | ');
    // Formato: Nivel 1 | Dorado | 2 morados | 98.02 %
    html += `<li style='margin-bottom:8px;padding:6px 0;border-bottom:1px solid #eee;display:flex;align-items:center;gap:8px;'>`;
    html += `<span style='font-weight:bold;'>Nivel ${r.nivel} | ${r.color.charAt(0).toUpperCase() + r.color.slice(1)}${materialesStr ? ' | ' + materialesStr : ''} | ${parseFloat(r.porcentaje).toFixed(2)} %</span> <span style='color:#1e3a8a;'>${tiempo} h</span>`;
    html += `<button onclick='eliminarRecetaTiempo(${i})' style='background:#e53935;color:#fff;border:none;border-radius:4px;padding:2px 8px;cursor:pointer;margin-left:8px;'>✖</button>`;
    html += `</li>`;
  });
  html += '</ul>';
  listaDiv.innerHTML = html;
  renderResumenTiempoRecetas();
}

function calcularTiempoReceta(receta) {
  let total = 0;
  for (const color in TIEMPOS_MATERIAL) {
    total += (receta.materiales[color] || 0) * TIEMPOS_MATERIAL[color];
  }
  return total;
}

function renderResumenTiempoRecetas() {
  const resumenDiv = document.getElementById('resumen-tiempo-recetas');
  if (!resumenDiv) return;
  // Sumar tiempos y materiales
  let totalHoras = 0;
  let totalMateriales = { dorado:0, morado:0, azul:0, verde:0, blanco:0 };
  recetasTiempo.forEach(idx => {
    const r = recetas[idx];
    if (!r) return;
    totalHoras += calcularTiempoReceta(r);
    for (const color in totalMateriales) {
      totalMateriales[color] += (r.materiales[color] || 0);
    }
  });
  // Formateo de horas con separador de miles
  const horasFormateadas = totalHoras.toLocaleString('es-MX');
  // Conversión a meses, semanas, días y horas
  let horasRestantes = totalHoras;
  const meses = Math.floor(horasRestantes / (30*24));
  horasRestantes = horasRestantes % (30*24);
  const semanas = Math.floor(horasRestantes / (7*24));
  horasRestantes = horasRestantes % (7*24);
  const dias = Math.floor(horasRestantes / 24);
  horasRestantes = horasRestantes % 24;
  // Construir string de conversión
  let partes = [];
  if (meses > 0) partes.push(`🗓️ ${meses} mes${meses > 1 ? 'es' : ''}`);
  if (semanas > 0) partes.push(`📆 ${semanas} semana${semanas > 1 ? 's' : ''}`);
  if (dias > 0) partes.push(`📅 ${dias} día${dias > 1 ? 's' : ''}`);
  if (horasRestantes > 0 || partes.length === 0) partes.push(`🕒 ${horasRestantes} hora${horasRestantes !== 1 ? 's' : ''}`);
  let conversionStr = partes.join(', ');
  let html = `<div style='margin-bottom:8px;'><strong>Tiempo total:</strong> <span style='color:#1e3a8a;font-size:1.1em;'>🕒 ${horasFormateadas} horas</span></div>`;
  html += `<div style='color:#555;margin-bottom:8px;font-size:1.08em;'>= ${conversionStr}</div>`;
  html += `<div style='margin-bottom:4px;'><strong>Materiales totales:</strong></div>`;
  html += `<div style='display:flex;gap:12px;flex-wrap:wrap;'>`;
  for (const color of ['dorado','morado','azul','verde','blanco']) {
    html += `<span style='background:#eee;padding:4px 10px;border-radius:8px;font-weight:bold;color:#333;'>${color.charAt(0).toUpperCase()+color.slice(1)}: ${totalMateriales[color]}</span>`;
  }
  html += `</div>`;
  resumenDiv.innerHTML = html;
}

function eliminarRecetaTiempo(i) {
  recetasTiempo.splice(i,1);
  renderListaTiempoRecetas();
}

document.getElementById('agregar-receta-tiempo').onclick = function() {
  // Mostrar selector de receta Normal
  const recetasNormales = recetas.map((r, idx) => ({...r, idx})).filter(r => r.clase === 'Normal');
  if (recetasNormales.length === 0) return;
  let opciones = '';
  recetasNormales.forEach(r => {
    // Construir string de materiales (solo los > 0)
    const materialesStr = Object.entries(r.materiales)
      .filter(([color, cantidad]) => cantidad > 0)
      .map(([color, cantidad]) => `${cantidad} ${color}${cantidad > 1 ? 's' : ''}`)
      .join(' | ');
    opciones += `<option value='${r.idx}'>Nivel ${r.nivel} | ${r.color.charAt(0).toUpperCase() + r.color.slice(1)}${materialesStr ? ' | ' + materialesStr : ''} | ${parseFloat(r.porcentaje).toFixed(2)} %</option>`;
  });
  const sel = document.createElement('select');
  sel.innerHTML = opciones;
  sel.style.marginRight = '8px';
  sel.style.padding = '4px 8px';
  sel.style.borderRadius = '6px';
  sel.style.fontSize = '1rem';
  const okBtn = document.createElement('button');
  okBtn.textContent = 'Agregar';
  okBtn.style.background = '#43a047';
  okBtn.style.color = '#fff';
  okBtn.style.border = 'none';
  okBtn.style.borderRadius = '6px';
  okBtn.style.padding = '4px 14px';
  okBtn.style.marginLeft = '6px';
  okBtn.style.cursor = 'pointer';
  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.top = '0';
  modal.style.left = '0';
  modal.style.width = '100vw';
  modal.style.height = '100vh';
  modal.style.background = 'rgba(0,0,0,0.18)';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.zIndex = '9999';
  const inner = document.createElement('div');
  inner.style.background = '#fff';
  inner.style.padding = '24px 18px 18px 18px';
  inner.style.borderRadius = '10px';
  inner.style.boxShadow = '0 4px 16px rgba(0,0,0,0.18)';
  inner.style.textAlign = 'center';
  inner.innerHTML = `<div style='font-size:1.1rem;margin-bottom:12px;'>Selecciona una receta Normal:</div>`;
  inner.appendChild(sel);
  inner.appendChild(okBtn);
  const cancelar = document.createElement('button');
  cancelar.textContent = 'Cancelar';
  cancelar.style.background = '#e53935';
  cancelar.style.color = '#fff';
  cancelar.style.border = 'none';
  cancelar.style.borderRadius = '6px';
  cancelar.style.padding = '4px 14px';
  cancelar.style.marginLeft = '8px';
  cancelar.style.cursor = 'pointer';
  inner.appendChild(cancelar);
  modal.appendChild(inner);
  document.body.appendChild(modal);
  okBtn.onclick = function() {
    const idx = parseInt(sel.value);
    recetasTiempo.push(idx);
    renderListaTiempoRecetas();
    document.body.removeChild(modal);
  };
  cancelar.onclick = function() {
    document.body.removeChild(modal);
  };
};
document.getElementById('limpiar-tiempo-recetas').onclick = function() {
  recetasTiempo = [];
  renderListaTiempoRecetas();
};

// Mostrar/ocultar analizador según recetas
renderTabla = (function(orig){
  return function() {
    orig.apply(this, arguments);
    mostrarAnalizadorTiempo();
  };
})(renderTabla);

let recetasTiempoSeleccion = {};

function abrirModalSeleccionRecetas() {
  // Obtener recetas normales
  const recetasNormales = recetas.map((r, idx) => ({...r, idx})).filter(r => r.clase === 'Normal');
  if (recetasNormales.length === 0) return;
  // Inicializar selección si está vacía
  if (!recetasTiempoSeleccion || typeof recetasTiempoSeleccion !== 'object') recetasTiempoSeleccion = {};
  // Modal
  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.top = '0';
  modal.style.left = '0';
  modal.style.width = '100vw';
  modal.style.height = '100vh';
  modal.style.background = 'rgba(0,0,0,0.6)';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.zIndex = '9999';
  // Contenido
  const inner = document.createElement('div');
  inner.style.background = '#fff';
  inner.style.padding = '28px 18px 18px 18px';
  inner.style.borderRadius = '12px';
  inner.style.boxShadow = '0 4px 16px rgba(0,0,0,0.18)';
  inner.style.textAlign = 'center';
  inner.style.maxWidth = '98vw';
  inner.style.width = 'min(600px,98vw)';
  inner.style.maxHeight = '90vh';
  inner.style.overflowY = 'auto';
  // Tabla
  let tabla = `<table id='tabla-modal-recetas-tiempo' style='width:100%;margin-bottom:18px;font-size:1rem;'><thead><tr><th>Nivel</th><th>Color</th><th>Materiales</th><th>% Éxito</th><th colspan='3'>Acciones</th></tr></thead><tbody>`;
  recetasNormales.forEach(r => {
    const materialesStr = Object.entries(r.materiales)
      .filter(([color, cantidad]) => cantidad > 0)
      .map(([color, cantidad]) => `${cantidad} ${color}${cantidad > 1 ? 's' : ''}`)
      .join(', ');
    const cantidad = recetasTiempoSeleccion[r.idx] || 0;
    const desvanecido = cantidad > 0;
    tabla += `<tr data-idx='${r.idx}' style='${desvanecido ? "color:rgba(80,80,80,0.66);" : ""}'>`;
    tabla += `<td>${r.nivel}</td>`;
    tabla += `<td>${r.color.charAt(0).toUpperCase() + r.color.slice(1)}</td>`;
    tabla += `<td>${materialesStr}</td>`;
    tabla += `<td>${parseFloat(r.porcentaje).toFixed(2)}%</td>`;
    tabla += `<td><button class='btn-mas' data-idx='${r.idx}' style='font-size:1.5em;padding:8px 18px;margin:0 10px;background:#43a047;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:opacity 0.2s;${desvanecido ? "opacity:0.3;pointer-events:none;" : ""}'>+</button></td>`;
    tabla += `<td><button class='btn-menos' data-idx='${r.idx}' style='font-size:1.5em;padding:8px 18px;margin:0 10px;background:#e53935;color:#fff;border:none;border-radius:8px;cursor:pointer;'>-</button></td>`;
    tabla += `<td style='font-weight:bold;font-size:1.1em;'>${cantidad > 0 ? cantidad : ''}</td>`;
    tabla += `</tr>`;
  });
  tabla += `</tbody></table>`;
  // Resumen de tiempo
  const resumenDiv = document.createElement('div');
  resumenDiv.id = 'modal-resumen-tiempo-recetas';
  resumenDiv.style.margin = '12px 0 18px 0';
  resumenDiv.style.fontSize = '1.08em';
  // Botón cerrar
  const cerrar = document.createElement('button');
  cerrar.textContent = 'Cerrar';
  cerrar.style.background = '#1e3a8a';
  cerrar.style.color = '#fff';
  cerrar.style.border = 'none';
  cerrar.style.borderRadius = '8px';
  cerrar.style.padding = '8px 24px';
  cerrar.style.fontSize = '1.1em';
  cerrar.style.marginTop = '10px';
  cerrar.style.cursor = 'pointer';
  cerrar.onclick = function() {
    document.body.removeChild(modal);
  };
  inner.innerHTML = `<div style='font-size:1.15em;font-weight:bold;margin-bottom:12px;'>Selecciona recetas de equipo Normal</div>${tabla}`;
  inner.appendChild(resumenDiv);
  inner.appendChild(cerrar);
  modal.appendChild(inner);
  document.body.appendChild(modal);
  // Eventos + y -
  setTimeout(() => {
    document.querySelectorAll('.btn-mas').forEach(btn => {
      btn.onclick = function() {
        const idx = this.getAttribute('data-idx');
        recetasTiempoSeleccion[idx] = 1;
        actualizarTablaModalRecetas();
      };
    });
    document.querySelectorAll('.btn-menos').forEach(btn => {
      btn.onclick = function() {
        const idx = this.getAttribute('data-idx');
        recetasTiempoSeleccion[idx] = 0;
        actualizarTablaModalRecetas();
      };
    });
  }, 10);
  actualizarResumenModalTiempo();
}

function actualizarTablaModalRecetas() {
  // Re-renderizar solo el tbody de la tabla
  const tbody = document.querySelector('#tabla-modal-recetas-tiempo tbody');
  if (!tbody) return;
  const recetasNormales = recetas.map((r, idx) => ({...r, idx})).filter(r => r.clase === 'Normal');
  let html = '';
  recetasNormales.forEach(r => {
    const materialesStr = Object.entries(r.materiales)
      .filter(([color, cantidad]) => cantidad > 0)
      .map(([color, cantidad]) => `${cantidad} ${color}${cantidad > 1 ? 's' : ''}`)
      .join(', ');
    const cantidad = recetasTiempoSeleccion[r.idx] || 0;
    const desvanecido = cantidad > 0;
    html += `<tr data-idx='${r.idx}' style='${desvanecido ? "color:rgba(80,80,80,0.66);" : ""}'>`;
    html += `<td>${r.nivel}</td>`;
    html += `<td>${r.color.charAt(0).toUpperCase() + r.color.slice(1)}</td>`;
    html += `<td>${materialesStr}</td>`;
    html += `<td>${parseFloat(r.porcentaje).toFixed(2)}%</td>`;
    html += `<td><button class='btn-mas' data-idx='${r.idx}' style='font-size:1.5em;padding:8px 18px;margin:0 10px;background:#43a047;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:opacity 0.2s;${desvanecido ? "opacity:0.3;pointer-events:none;" : ""}'>+</button></td>`;
    html += `<td><button class='btn-menos' data-idx='${r.idx}' style='font-size:1.5em;padding:8px 18px;margin:0 10px;background:#e53935;color:#fff;border:none;border-radius:8px;cursor:pointer;'>-</button></td>`;
    html += `<td style='font-weight:bold;font-size:1.1em;'>${cantidad > 0 ? cantidad : ''}</td>`;
    html += `</tr>`;
  });
  tbody.innerHTML = html;
  // Reasignar eventos
  document.querySelectorAll('.btn-mas').forEach(btn => {
    btn.onclick = function() {
      const idx = this.getAttribute('data-idx');
      recetasTiempoSeleccion[idx] = 1;
      actualizarTablaModalRecetas();
    };
  });
  document.querySelectorAll('.btn-menos').forEach(btn => {
    btn.onclick = function() {
      const idx = this.getAttribute('data-idx');
      recetasTiempoSeleccion[idx] = 0;
      actualizarTablaModalRecetas();
    };
  });
  actualizarResumenModalTiempo();
}

function actualizarResumenModalTiempo() {
  // Calcular el total de horas y materiales
  let totalHoras = 0;
  let totalMateriales = { dorado:0, morado:0, azul:0, verde:0, blanco:0 };
  Object.entries(recetasTiempoSeleccion).forEach(([idx, cantidad]) => {
    cantidad = parseInt(cantidad);
    if (!cantidad || cantidad <= 0) return;
    const r = recetas[idx];
    if (!r) return;
    totalHoras += calcularTiempoReceta(r) * cantidad;
    for (const color in totalMateriales) {
      totalMateriales[color] += (r.materiales[color] || 0) * cantidad;
    }
  });
  // Conversión a meses, semanas, días, horas
  const horasFormateadas = totalHoras.toLocaleString('es-MX');
  let horasRestantes = totalHoras;
  const meses = Math.floor(horasRestantes / (30*24));
  horasRestantes = horasRestantes % (30*24);
  const semanas = Math.floor(horasRestantes / (7*24));
  horasRestantes = horasRestantes % (7*24);
  const dias = Math.floor(horasRestantes / 24);
  horasRestantes = horasRestantes % 24;
  let partes = [];
  if (meses > 0) partes.push(`🗓️ ${meses} mes${meses > 1 ? 'es' : ''}`);
  if (semanas > 0) partes.push(`📆 ${semanas} semana${semanas > 1 ? 's' : ''}`);
  if (dias > 0) partes.push(`📅 ${dias} día${dias > 1 ? 's' : ''}`);
  if (horasRestantes > 0 || partes.length === 0) partes.push(`🕒 ${horasRestantes} hora${horasRestantes !== 1 ? 's' : ''}`);
  let conversionStr = partes.join(', ');
  let html = `<div style='margin-bottom:8px;'><strong>Tiempo total:</strong> <span style='color:#1e3a8a;font-size:1.1em;'>🕒 ${horasFormateadas} horas</span></div>`;
  html += `<div style='color:#555;margin-bottom:8px;font-size:1.08em;'>= ${conversionStr}</div>`;
  html += `<div style='margin-bottom:4px;'><strong>Materiales totales:</strong></div>`;
  html += `<div style='display:flex;gap:12px;flex-wrap:wrap;'>`;
  for (const color of ['dorado','morado','azul','verde','blanco']) {
    html += `<span style='background:#eee;padding:4px 10px;border-radius:8px;font-weight:bold;color:#333;'>${color.charAt(0).toUpperCase()+color.slice(1)}: ${totalMateriales[color]}</span>`;
  }
  html += `</div>`;
  document.getElementById('modal-resumen-tiempo-recetas').innerHTML = html;
}
</script>
</body>
</html> 