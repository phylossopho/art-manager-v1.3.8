<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Materiales - Deck Heroes</title>

    <!-- Hojas de estilo -->
    <link rel="stylesheet" href="estilos/principal.css">
    <link rel="stylesheet" href="estilos/tablas.css">
    <link rel="stylesheet" href="estilos/modales.css">
    <link rel="stylesheet" href="estilos/galeria.css">
    <link rel="stylesheet" href="estilos/responsive.css">

    <style>
        /* Nuevos estilos para tabla ARTE */
        #arte-table table {
            width: 100%;
            border-collapse: collapse;
        }

        #arte-table th,
        #arte-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }

        #arte-table td {
            vertical-align: middle;
        }

        #arte-table img {
            width: 33px;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* === ESTILOS TOAST === */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
        }

        .toast {
            min-width: 250px;
            background-color: #333;
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 350px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-header {
            padding: 10px 15px;
            background-color: rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toast-title {
            font-size: 16px;
            font-weight: bold;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .toast-body {
            padding: 15px;
            font-size: 14px;
        }

        /* Tipos de toast */
        .toast-success {
            background-color: #4CAF50;
        }

        .toast-error {
            background-color: #f44336;
        }

        .toast-info {
            background-color: #2196F3;
        }

        .toast-warning {
            background-color: #ff9800;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Bot√≥n CSV m√≥vil -->
    <div class="mobile-csv-toggle-container">
        <button id="csv-menu-toggle" class="mobile-only">
            <i class="file-icon"></i>
        </button>
    </div>

    <!-- Men√∫ CSV m√≥vil -->
    <div class="mobile-csv-menu" id="mobile-csv-menu">
        <button id="mobile-export-csv">Exportar CSV</button>
        <button id="mobile-import-csv">Importar CSV</button>
    </div>

    <header>
        <h1>Gestor de Materiales y de Equipos</h1>
    </header>

    <div class="top-section">
        <div class="left-panel">
            <div class="equipment-image">
                <img id="equipment-img" src="images/botas.png" alt="Equipo" onerror="this.style.display='none'">
            </div>

            <div class="selectors-grid">
                <div class="selector-column">
                    <select id="equipment-select">
                        <option value="Espada">Espada</option>
                        <option value="Pecho">Pecho</option>
                        <option value="Botas">Botas</option>
                        <option value="Casco">Casco</option>
                        <option value="Guantes">Guantes</option>
                        <option value="Cintur√≥n">Cintur√≥n</option>
                    </select>

                    <!-- SELECTOR DE CLASE ACTUALIZADO -->
                    <select id="class-select">
                        <option value="Normal">Normal</option>
                        <option value="Campe√≥n">Campe√≥n</option>
                        <option value="Planewalker">Planewalker</option>
                        <option value="Lord">Lord</option>
                        <option value="Noble Lord">Noble Lord</option>
                    </select>
                </div>

                <div class="selector-column">
                    <select id="level-select">
                        <option value="1">Nivel 1</option>
                        <option value="2">Nivel 2</option>
                        <option value="3">Nivel 3</option>
                        <option value="4">Nivel 4</option>
                        <option value="5">Nivel 5</option>
                    </select>

                    <select id="color-select">
                        <option value="blanco">Blanco</option>
                        <option value="verde">Verde</option>
                        <option value="azul">Azul</option>
                        <option value="morado">Morado</option>
                        <option value="dorado">Dorado</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- Botones originales para escritorio -->
            <button id="export-csv" class="desktop-only">Exportar CSV</button>
            <button id="import-csv" class="desktop-only">Importar CSV</button>
            <input type="file" id="csv-file" accept=".csv" style="display: none;">
            <button id="show-materials">Mostrar Materiales</button>
            <!-- Icono flotante de guardar/abrir datos -->
            <div id="fab-save-menu-container" style="position: relative;">
                <button id="fab-save" title="Opciones de datos" style="position: absolute; top: 60px; right: 0; z-index: 100; width: 48px; height: 48px; border-radius: 50%; background: #2196F3; box-shadow: 0 4px 12px rgba(0,0,0,0.18); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" fill="#fff" stroke="#1976d2" stroke-width="2"/>
                        <path d="M7 3V7H17V3" stroke="#1976d2" stroke-width="2"/>
                        <rect x="7" y="13" width="10" height="5" rx="1" fill="#1976d2"/>
                        <rect x="9" y="15" width="6" height="1.5" rx="0.75" fill="#fff"/>
                    </svg>
                </button>
                <div id="fab-save-menu" style="display: none; position: absolute; top: 115%; right: 0; background: #fff; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.18); min-width: 140px; overflow: hidden; border: 1px solid #e0e0e0;">
                    <button id="fab-save-download" style="width: 100%; padding: 10px 16px; background: none; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 4v12m0 0l-4-4m4 4l4-4" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="18" width="16" height="2" rx="1" fill="#1976d2"/></svg> Guardar</button>
                    <button id="fab-save-upload" style="width: 100%; padding: 10px 16px; background: none; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 20V8m0 0l-4 4m4-4l4 4" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="4" width="16" height="2" rx="1" fill="#1976d2"/></svg> Abrir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pesta√±as de conversi√≥n -->
    <div class="tabs-container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="materials">Materiales</button>
            <button class="tab-button" data-tab="conversion1">>> Verde</button>
            <button class="tab-button" data-tab="conversion2">>> Azul</button>
            <button class="tab-button" data-tab="conversion3">>> Morado</button>
            <button class="tab-button" data-tab="conversionfinal">>> Dorado</button>
            <button class="tab-button conversion-legend-tab" data-tab="conversionlegend" title="Leyenda de Conversi√≥n">
                <i class="info-icon"></i>
            </button>
            <!-- NUEVA PESTA√ëA ARTE -->
            <button class="tab-button" data-tab="arte">ARTE</button>
        </div>
    </div>

    <!-- Contenido de las pesta√±as -->
    <div class="tab-content active" id="materials-tab">
        <div class="materials-table" id="materials-table">
            <!-- Tabla de materiales se generar√° din√°micamente -->
        </div>
    </div>

    <div class="tab-content" id="conversion1-tab">
        <div class="materials-table" id="conversion1-table">
            <!-- Tabla de conversi√≥n 1 se generar√° din√°micamente -->
        </div>
    </div>

    <div class="tab-content" id="conversion2-tab">
        <div class="materials-table" id="conversion2-table">
            <!-- Tabla de conversi√≥n 2 se generar√° din√°micamente -->
        </div>
    </div>

    <div class="tab-content" id="conversion3-tab">
        <div class="materials-table" id="conversion3-table">
            <!-- Tabla de conversi√≥n 3 se generar√° din√°micamente -->
        </div>
    </div>

    <div class="tab-content" id="conversionfinal-tab">
        <div class="materials-table" id="conversionfinal-table">
            <!-- Tabla de conversi√≥n final se generar√° din√°micamente -->
        </div>
    </div>

    <div class="tab-content" id="conversionlegend-tab">
        <div class="conversion-description">
            <p><strong>Tabla de Conversi√≥n de Materiales:</strong></p>
        </div>
        <div class="materials-table" id="conversionlegend-table">
            <table class="conversion-legend-table">
                <thead>
                <tr>
                    <th></th>
                    <th>Blanco</th>
                    <th>Verde</th>
                    <th>Azul</th>
                    <th>Morado</th>
                    <th>Dorado</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <th>Dorado</th>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>1</td>
                </tr>
                <tr>
                    <th>Morado</th>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>1</td>
                    <td>4</td>
                </tr>
                <tr>
                    <th>Azul</th>
                    <td>0</td>
                    <td>0</td>
                    <td>1</td>
                    <td>4</td>
                    <td>16</td>
                </tr>
                <tr>
                    <th>Verde</th>
                    <td>0</td>
                    <td>1</td>
                    <td>4</td>
                    <td>16</td>
                    <td>64</td>
                </tr>
                <tr>
                    <th>Blanco</th>
                    <td>1</td>
                    <td>4</td>
                    <td>16</td>
                    <td>64</td>
                    <td>256</td>
                </tr>
                </tbody>
            </table>
            <div class="conversion-notes">
                <p><strong>Equivalencias:</strong></p>
                <ul>
                    <li>4 Blancos = 1 Verde</li>
                    <li>4 Verdes = 1 Azul</li>
                    <li>4 Azules = 1 Morado</li>
                    <li>4 Morados = 1 Dorado</li>
                    <li>16 Blancos = 1 Azul</li>
                    <li>16 Verdes = 1 Morado</li>
                    <li>16 Azules = 1 Dorado</li>
                    <li>64 Blancos = 1 Morado</li>
                    <li>64 Verdes = 1 Dorado</li>
                    <li>256 Blancos = 1 Dorado</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- NUEVA PESTA√ëA ARTE -->
    <div class="tab-content" id="arte-tab">
        <div class="materials-table" id="arte-table">
            <!-- La tabla de equipos simulados se generar√° din√°micamente aqu√≠ -->
        </div>
        <!-- Bot√≥n Volver a Materiales -->
        <div class="arte-back-container">
            <button id="arte-back-button" class="back-button">‚Üê Volver a Materiales</button>
        </div>
    </div>

    <div class="bottom-section" id="bottom-section">
        <!-- Selectores de color por material se generar√°n din√°micamente -->
    </div>

    <div class="bottom-buttons">
        <button id="gallery-button" class="gallery-button">
            <i class="gallery-icon"></i>
        </button>
        
        <!-- Iconos de redes sociales -->
        <div class="social-icons">
            <a href="https://chat.whatsapp.com/DN5X1L7BqiJAMk4llRkLrN" target="_blank" class="social-icon" title="Grupo de WhatsApp - ‚öî ùêÆùêßùê¢ùê®ùêß ùêùùêû ùê°ùêûùê´ùê®ùêûùê¨ ‚öî">
                <img src="images/whatsapp.png" alt="WhatsApp" onerror="this.style.display='none'">
            </a>
            <a href="https://t.me/+MJ8GLGcdPX9iMTcx" target="_blank" class="social-icon" title="Grupo de Telegram - ‚öîÔ∏è ùêÆùêßùê¢ùê®ùêß ùêùùêû ùê°ùêûùê´ùê®ùêûùê¨ ‚öîÔ∏è">
                <img src="images/telegram.png" alt="Telegram" onerror="this.style.display='none'">
            </a>
            <a href="https://www.youtube.com/@DecodificandoDH" target="_blank" class="social-icon" title="Canal de YouTube - Decodificando DH">
                <img src="images/decodificando.png" alt="YouTube" onerror="this.style.display='none'">
            </a>
        </div>
        
        <button id="use-materials" class="use-button">USAR</button>
    </div>

    <!-- Modal para galer√≠a de im√°genes -->
    <div id="gallery-modal" class="modal">
        <div class="modal-content gallery-modal-content">
            <div class="modal-header">
                <h2>Galer√≠a de Im√°genes</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="gallery-container" class="gallery-container">
                    <!-- Las im√°genes se cargar√°n din√°micamente aqu√≠ -->
                </div>
                <button id="add-image-button" class="floating-add-button" title="Agregar Imagen">
                    <span class="plus-icon">+</span>
                </button>
                <input type="file" id="gallery-file-input" accept="image/*" style="display: none;">
            </div>
        </div>
    </div>

    <!-- Modal para carrusel de im√°genes -->
    <div id="carousel-modal" class="modal">
        <div class="modal-content carousel-modal-content">
            <div class="carousel-container">
                <button class="carousel-nav prev" id="carousel-prev">‚Äπ</button>
                <div class="carousel-image-container">
                    <img id="carousel-image" src="" alt="Imagen actual">
                </div>
                <button class="carousel-nav next" id="carousel-next">‚Ä∫</button>
            </div>
            <div class="carousel-info">
                <span id="carousel-counter">1 / 1</span>
                <button class="carousel-close" id="carousel-close">√ó</button>
            </div>
        </div>
    </div>

    <!-- Modal para lista completa de materiales -->
    <div id="materials-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lista Completa de Materiales</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="all-materials-table">
                    <!-- Tabla completa se generar√° din√°micamente -->
                </div>
            </div>
            <!-- Bot√≥n Volver -->
            <div class="modal-footer">
                <button id="materials-back-button" class="back-button">Volver</button>
            </div>
        </div>
    </div>

    <!-- Contenedor para notificaciones tipo toast -->
    <div id="toast-container">
        <!-- Plantilla para toasts (oculta por defecto) -->
        <div class="toast" id="toast-template" style="display: none;">
            <div class="toast-header">
                <strong class="toast-title"></strong>
                <button type="button" class="toast-close">&times;</button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>
</div>

<!-- === SCRIPTS === -->
<script type="module" src="scripts/app.js"></script>

<script>
    // Animaci√≥n de iconos sociales con scroll
    function handleSocialIconsAnimation() {
        const socialIcons = document.querySelector('.social-icons');
        if (!socialIcons) return;

        const rect = socialIcons.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        
        // Calcular cu√°ndo debe aparecer (cuando el elemento est√° a 200px de entrar en pantalla)
        const triggerPoint = windowHeight - 200;
        
        if (rect.top <= triggerPoint) {
            socialIcons.classList.add('reveal');
        }
    }

    // Escuchar el evento de scroll
    window.addEventListener('scroll', handleSocialIconsAnimation);
    
    // Activar la animaci√≥n inmediatamente al cargar la p√°gina
    window.addEventListener('load', () => {
        const socialIcons = document.querySelector('.social-icons');
        if (socialIcons) {
            // Peque√±o delay para que se vea la animaci√≥n
            setTimeout(() => {
                socialIcons.classList.add('reveal');
            }, 1000);
        }
    });
    
    // Tambi√©n ejecutar al cargar la p√°gina por si ya est√° en la posici√≥n correcta
    window.addEventListener('load', handleSocialIconsAnimation);

    // === FUNCIONES DE DEBUGGING PARA SISTEMA ROBUSTO ===
    // Estas funciones est√°n disponibles en la consola del navegador para debugging
    
    // Funci√≥n para detectar si es un dispositivo m√≥vil
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               (window.innerWidth <= 768);
    }
    
    // Funci√≥n para verificar el estado del storage robusto
    window.debugStorage = function() {
        console.log('=== DEBUG SISTEMA ROBUSTO ===');
        console.log('üì± Dispositivo m√≥vil:', isMobileDevice() ? 'S√ç' : 'NO');
        console.log('üåê User Agent:', navigator.userAgent);
        console.log('üìè Ancho de pantalla:', window.innerWidth);
        
        // Verificar disponibilidad de storages
        let localStorageAvailable = false;
        let sessionStorageAvailable = false;
        let indexedDBAvailable = false;
        
        try {
            const test = '__test__';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            localStorageAvailable = true;
            console.log('‚úÖ localStorage est√° disponible');
        } catch (e) {
            console.error('‚ùå localStorage NO est√° disponible:', e);
        }
        
        try {
            const test = '__test__';
            sessionStorage.setItem(test, test);
            sessionStorage.removeItem(test);
            sessionStorageAvailable = true;
            console.log('‚úÖ sessionStorage est√° disponible');
        } catch (e) {
            console.error('‚ùå sessionStorage NO est√° disponible:', e);
        }
        
        try {
            indexedDBAvailable = !!window.indexedDB;
            console.log('‚úÖ IndexedDB est√° disponible:', indexedDBAvailable);
        } catch (e) {
            console.error('‚ùå IndexedDB NO est√° disponible:', e);
        }
        
        if (!localStorageAvailable && !sessionStorageAvailable && !indexedDBAvailable) {
            console.error('‚ùå NING√öN STORAGE DISPONIBLE');
            return;
        }
        
        // Verificar datos guardados en localStorage
        if (localStorageAvailable) {
            console.log('\nüì¶ LOCALSTORAGE:');
            const materiales = localStorage.getItem('almacenMateriales');
            const imagenes = localStorage.getItem('imagenesGaleria');
            const equipos = localStorage.getItem('equiposSimulados');
            
            console.log('   Materiales guardados:', materiales ? 'S√ç' : 'NO');
            if (materiales) {
                try {
                    const parsed = JSON.parse(materiales);
                    console.log('   - Cantidad de materiales:', Object.keys(parsed).length);
                    console.log('   - Tama√±o de datos:', (materiales.length / 1024).toFixed(2) + ' KB');
                } catch (e) {
                    console.error('   - Error al parsear materiales:', e);
                }
            }
            
            console.log('   Im√°genes guardadas:', imagenes ? 'S√ç' : 'NO');
            if (imagenes) {
                try {
                    const parsed = JSON.parse(imagenes);
                    console.log('   - Cantidad de im√°genes:', parsed.length);
                    console.log('   - Tama√±o de datos:', (imagenes.length / 1024).toFixed(2) + ' KB');
                } catch (e) {
                    console.error('   - Error al parsear im√°genes:', e);
                }
            }
            
            console.log('   Equipos simulados:', equipos ? 'S√ç' : 'NO');
            if (equipos) {
                try {
                    const parsed = JSON.parse(equipos);
                    console.log('   - Cantidad de equipos:', parsed.length);
                    console.log('   - Tama√±o de datos:', (equipos.length / 1024).toFixed(2) + ' KB');
                } catch (e) {
                    console.error('   - Error al parsear equipos:', e);
                }
            }
        }
        
        // Verificar datos guardados en sessionStorage
        if (sessionStorageAvailable) {
            console.log('\nüì¶ SESSIONSTORAGE:');
            const materiales = sessionStorage.getItem('almacenMateriales');
            const imagenes = sessionStorage.getItem('imagenesGaleria');
            const equipos = sessionStorage.getItem('equiposSimulados');
            
            console.log('   Materiales guardados:', materiales ? 'S√ç' : 'NO');
            if (materiales) {
                try {
                    const parsed = JSON.parse(materiales);
                    console.log('   - Cantidad de materiales:', Object.keys(parsed).length);
                    console.log('   - Tama√±o de datos:', (materiales.length / 1024).toFixed(2) + ' KB');
                } catch (e) {
                    console.error('   - Error al parsear materiales:', e);
                }
            }
            
            console.log('   Im√°genes guardadas:', imagenes ? 'S√ç' : 'NO');
            if (imagenes) {
                try {
                    const parsed = JSON.parse(imagenes);
                    console.log('   - Cantidad de im√°genes:', parsed.length);
                    console.log('   - Tama√±o de datos:', (imagenes.length / 1024).toFixed(2) + ' KB');
                } catch (e) {
                    console.error('   - Error al parsear im√°genes:', e);
                }
            }
            
            console.log('   Equipos simulados:', equipos ? 'S√ç' : 'NO');
            if (equipos) {
                try {
                    const parsed = JSON.parse(equipos);
                    console.log('   - Cantidad de equipos:', parsed.length);
                    console.log('   - Tama√±o de datos:', (equipos.length / 1024).toFixed(2) + ' KB');
                } catch (e) {
                    console.error('   - Error al parsear equipos:', e);
                }
            }
        }
        
        // Verificar espacio disponible
        let totalSize = 0;
        if (localStorageAvailable) {
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length;
                }
            }
        }
        console.log('\nüíæ Espacio total usado:', (totalSize / 1024).toFixed(2) + ' KB');
        console.log('üìä Espacio disponible (estimado): ~5-10 MB');
        
        // Mostrar recomendaciones
        console.log('\nüí° RECOMENDACIONES:');
        if (!localStorageAvailable && !sessionStorageAvailable) {
            console.log('   ‚ö†Ô∏è localStorage y sessionStorage no disponibles');
            if (indexedDBAvailable) {
                console.log('   ‚úÖ IndexedDB disponible - usar sistema robusto');
            }
        }
        
        // Mostrar m√©todo de almacenamiento recomendado
        if (isMobileDevice()) {
            console.log('   üì± Dispositivo m√≥vil detectado - usando doble almacenamiento');
        } else {
            console.log('   üíª Dispositivo de escritorio - usando almacenamiento simple');
        }
    };
    
    // Funci√≥n para limpiar storage
    window.clearStorage = function() {
        if (confirm('¬øEst√°s seguro de que quieres limpiar todos los datos guardados? Esta acci√≥n no se puede deshacer.')) {
            localStorage.clear();
            sessionStorage.clear();
            console.log('üóëÔ∏è Storages limpiados completamente');
            alert('Datos limpiados. Recarga la p√°gina para ver los cambios.');
        }
    };
    
    // Funci√≥n para exportar datos del storage
    window.exportStorage = function() {
        const data = {
            localStorage: {
                materiales: localStorage.getItem('almacenMateriales'),
                imagenes: localStorage.getItem('imagenesGaleria'),
                equipos: localStorage.getItem('equiposSimulados')
            },
            sessionStorage: {
                materiales: sessionStorage.getItem('almacenMateriales'),
                imagenes: sessionStorage.getItem('imagenesGaleria'),
                equipos: sessionStorage.getItem('equiposSimulados')
            },
            deviceInfo: {
                isMobile: isMobileDevice(),
                userAgent: navigator.userAgent,
                screenWidth: window.innerWidth,
                timestamp: new Date().toISOString()
            }
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'storage-backup-' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
        
        console.log('üíæ Backup de storages exportado');
    };
    
    // Funci√≥n para importar datos al storage
    window.importStorage = function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Importar datos de localStorage
                        if (data.localStorage) {
                            if (data.localStorage.materiales) localStorage.setItem('almacenMateriales', data.localStorage.materiales);
                            if (data.localStorage.imagenes) localStorage.setItem('imagenesGaleria', data.localStorage.imagenes);
                            if (data.localStorage.equipos) localStorage.setItem('equiposSimulados', data.localStorage.equipos);
                        }
                        
                        // Importar datos de sessionStorage
                        if (data.sessionStorage) {
                            if (data.sessionStorage.materiales) sessionStorage.setItem('almacenMateriales', data.sessionStorage.materiales);
                            if (data.sessionStorage.imagenes) sessionStorage.setItem('imagenesGaleria', data.sessionStorage.imagenes);
                            if (data.sessionStorage.equipos) sessionStorage.setItem('equiposSimulados', data.sessionStorage.equipos);
                        }
                        
                        console.log('üì• Datos importados exitosamente');
                        alert('Datos importados. Recarga la p√°gina para ver los cambios.');
                    } catch (error) {
                        console.error('‚ùå Error al importar datos:', error);
                        alert('Error al importar datos. Verifica que el archivo sea v√°lido.');
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    };
    
    // Funci√≥n para forzar guardado en ambos storages
    window.forceSave = function() {
        try {
            // Obtener datos actuales
            const materiales = localStorage.getItem('almacenMateriales') || sessionStorage.getItem('almacenMateriales');
            const imagenes = localStorage.getItem('imagenesGaleria') || sessionStorage.getItem('imagenesGaleria');
            const equipos = localStorage.getItem('equiposSimulados') || sessionStorage.getItem('equiposSimulados');
            
            // Guardar en ambos storages
            if (materiales) {
                localStorage.setItem('almacenMateriales', materiales);
                sessionStorage.setItem('almacenMateriales', materiales);
            }
            if (imagenes) {
                localStorage.setItem('imagenesGaleria', imagenes);
                sessionStorage.setItem('imagenesGaleria', imagenes);
            }
            if (equipos) {
                localStorage.setItem('equiposSimulados', equipos);
                sessionStorage.setItem('equiposSimulados', equipos);
            }
            
            console.log('üíæ Guardado forzado completado');
            alert('Datos guardados en ambos storages. Recarga la p√°gina para verificar.');
        } catch (error) {
            console.error('‚ùå Error en guardado forzado:', error);
            alert('Error al forzar guardado.');
        }
    };
    
    // Mostrar informaci√≥n de debugging al cargar
    window.addEventListener('load', () => {
        console.log('üîß Funciones de debugging disponibles:');
        console.log('   - debugStorage() - Verificar estado del sistema robusto');
        console.log('   - clearStorage() - Limpiar todos los datos');
        console.log('   - exportStorage() - Exportar backup de datos');
        console.log('   - importStorage() - Importar backup de datos');
        console.log('   - forceSave() - Forzar guardado en ambos storages');
        console.log('');
        console.log('üí° Ejecuta debugStorage() para ver el estado actual');
        console.log('üì± Dispositivo m√≥vil detectado:', isMobileDevice() ? 'S√ç' : 'NO');
    });

    // FAB men√∫ guardar/abrir datos
    const fabSave = document.getElementById('fab-save');
    const fabMenu = document.getElementById('fab-save-menu');
    const fabDownload = document.getElementById('fab-save-download');
    const fabUpload = document.getElementById('fab-save-upload');

    fabSave.addEventListener('click', (e) => {
        e.stopPropagation();
        fabMenu.style.display = fabMenu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
        if (fabMenu.style.display === 'block') {
            fabMenu.style.display = 'none';
        }
    });
    fabMenu.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    // Guardar datos (descargar JSON)
    fabDownload.addEventListener('click', function() {
        try {
            const estado = window.estadoApp || {};
            let equiposSimulados = [];
            try { equiposSimulados = window.equiposSimulados || []; } catch (e) {}
            const data = {
                materiales: estado.almacenMateriales || {},
                galeria: estado.imagenesGaleria || [],
                simulaciones: equiposSimulados || []
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'backup-art-manager-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            alert('¬°Datos guardados exitosamente!');
        } catch (e) {
            alert('Error al guardar los datos: ' + e.message);
        }
        fabMenu.style.display = 'none';
    });

    // Abrir datos (importar JSON)
    fabUpload.addEventListener('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        // Sobrescribir los datos en memoria
                        if (window.estadoApp) {
                            window.estadoApp.almacenMateriales = data.materiales || {};
                            window.estadoApp.imagenesGaleria = data.galeria || [];
                        }
                        if (window.equiposSimulados && Array.isArray(data.simulaciones)) {
                            window.equiposSimulados.length = 0;
                            window.equiposSimulados.push(...data.simulaciones);
                        }
                        // Refrescar la UI
                        if (window.estadoApp && window.estadoApp.mapaColores) {
                            if (window.ui && window.ui.actualizarUI) {
                                window.ui.actualizarUI(window.estadoApp);
                            } else {
                                location.reload();
                            }
                        } else {
                            location.reload();
                        }
                        alert('¬°Datos cargados exitosamente!');
                    } catch (error) {
                        alert('Error al cargar los datos: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
        fabMenu.style.display = 'none';
    });
</script>

</body>
</html>
